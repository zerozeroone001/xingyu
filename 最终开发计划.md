# 诗词平台 - 最终开发计划

> **项目名称**: 星语诗词平台
> **项目定位**: 面向诗词爱好者的多端互动平台
> **技术方案**: Python后端 + 第三方AI API
> **更新时间**: 2025-11-06

---

## 目录

- [一、技术架构](#一技术架构)
- [二、技术栈与版本](#二技术栈与版本)
- [三、项目目录结构](#三项目目录结构)
- [四、接口规范](#四接口规范)
- [五、代码规范](#五代码规范)
- [六、数据库设计](#六数据库设计)
- [七、开发环境配置](#七开发环境配置)
- [八、开发流程](#八开发流程)
- [九、部署方案](#九部署方案)
- [十、开发排期](#十开发排期)

---

## 一、技术架构

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    客户端层                               │
├─────────────────────────────────────────────────────────┤
│  微信小程序 + H5 (uni-app Vue 3)                         │
│  管理后台 (Vue 3 + Element Plus)                         │
└─────────────────────────────────────────────────────────┘
                          ↓ HTTPS
┌─────────────────────────────────────────────────────────┐
│                    网关层                                 │
├─────────────────────────────────────────────────────────┤
│  Nginx (反向代理、负载均衡、SSL)                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                 应用服务层 (Python)                       │
├─────────────────────────────────────────────────────────┤
│  FastAPI (REST API)                                      │
│  WebSocket (实时通信 - 飞花令)                            │
│  Celery Worker (异步任务)                                │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    数据层                                 │
├─────────────────────────────────────────────────────────┤
│  MySQL 8.0 (主数据存储)                                  │
│  Redis 7.0 (缓存、会话、消息队列)                         │
│  Elasticsearch 7.17 (全文搜索)                           │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                 第三方服务层                              │
├─────────────────────────────────────────────────────────┤
│  阿里云通义千问 API (AI诗词生成、分析)                    │
│  百度文心一言 API (备用AI服务)                            │
│  阿里云OSS (对象存储 - 图片、文件)                        │
│  微信API (小程序登录、支付)                               │
└─────────────────────────────────────────────────────────┘
```

### 1.2 核心特性

- **多端适配**: 小程序 + H5 + 管理后台
- **AI驱动**: 调用第三方AI API实现智能功能
- **高性能**: FastAPI异步框架 + Redis缓存
- **实时互动**: WebSocket支持飞花令游戏
- **全文搜索**: Elasticsearch实现诗词检索

---

## 二、技术栈与版本

### 2.1 前端技术栈

#### 用户端 (小程序 + H5)

| 技术 | 版本 | 说明 |
|------|------|------|
| **uni-app** | `3.0.0-alpha-3090420231129001` | 多端框架 |
| **Vue** | `^3.3.4` | 前端框架 |
| **Pinia** | `^2.1.6` | 状态管理 |
| **axios** | `^1.4.0` | HTTP客户端 |
| **uni-ui** | `^1.4.28` | UI组件库 |
| **dayjs** | `^1.11.9` | 日期处理 |
| **socket.io-client** | `^4.7.2` | WebSocket客户端 |

#### 管理后台

| 技术 | 版本 | 说明 |
|------|------|------|
| **Vue** | `^3.3.4` | 前端框架 |
| **Vite** | `^4.4.9` | 构建工具 |
| **Element Plus** | `^2.3.14` | UI组件库 |
| **Vue Router** | `^4.2.4` | 路由管理 |
| **Pinia** | `^2.1.6` | 状态管理 |
| **axios** | `^1.4.0` | HTTP客户端 |
| **echarts** | `^5.4.3` | 图表库 |
| **@vueuse/core** | `^10.4.1` | Vue组合式工具库 |

### 2.2 后端技术栈

#### 核心框架

| 技术 | 版本 | 说明 |
|------|------|------|
| **Python** | `^3.11` | 编程语言 |
| **FastAPI** | `^0.104.1` | Web框架 |
| **Uvicorn** | `^0.24.0` | ASGI服务器 |
| **Pydantic** | `^2.5.0` | 数据验证 |
| **SQLAlchemy** | `^2.0.23` | ORM框架 |

#### 数据库驱动

| 技术 | 版本 | 说明 |
|------|------|------|
| **aiomysql** | `^0.2.0` | MySQL异步驱动 |
| **redis** | `^5.0.1` | Redis客户端 |
| **elasticsearch** | `^7.17.9` | ES客户端 |

#### 任务队列

| 技术 | 版本 | 说明 |
|------|------|------|
| **celery** | `^5.3.4` | 任务队列 |
| **celery-beat** | `^2.5.0` | 定时任务 |

#### 认证安全

| 技术 | 版本 | 说明 |
|------|------|------|
| **python-jose[cryptography]** | `^3.3.0` | JWT处理 |
| **passlib[bcrypt]** | `^1.7.4` | 密码加密 |
| **python-multipart** | `^0.0.6` | 文件上传 |

#### AI集成 (第三方API调用)

| 技术 | 版本 | 说明 |
|------|------|------|
| **httpx** | `^0.25.1` | 异步HTTP客户端 |
| **dashscope** | `^1.13.0` | 阿里云通义千问SDK |
| **qianfan** | `^0.2.2` | 百度千帆SDK |

#### 开发工具

| 技术 | 版本 | 说明 |
|------|------|------|
| **pytest** | `^7.4.3` | 测试框架 |
| **pytest-asyncio** | `^0.21.1` | 异步测试 |
| **black** | `^23.11.0` | 代码格式化 |
| **ruff** | `^0.1.6` | 代码检查 |
| **mypy** | `^1.7.1` | 类型检查 |

### 2.3 数据库技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| **MySQL** | `^8.0` | 主数据库 |
| **Redis** | `^7.0` | 缓存、队列 |
| **Elasticsearch** | `^7.17` | 全文搜索 |

### 2.4 部署运维

| 技术 | 版本 | 说明 |
|------|------|------|
| **Docker** | `^24.0` | 容器化 |
| **Docker Compose** | `^2.21` | 容器编排 |
| **Nginx** | `^1.24` | 反向代理 |

---

## 三、项目目录结构

### 3.1 整体结构

```
poetry-platform/
├── client-app/              # 用户端 (uni-app)
├── admin-web/               # 管理后台 (Vue3 + Element Plus)
├── server/                  # 后端服务 (Python FastAPI)
├── docs/                    # 项目文档
├── deploy/                  # 部署配置
└── README.md                # 项目说明
```

### 3.2 用户端目录 (client-app/)

```
client-app/  (uni-app)
├── src/
│   ├── api/                    # API接口
│   │   ├── request.js          # axios封装
│   │   ├── user.js             # 用户接口
│   │   ├── poetry.js           # 诗词接口
│   │   ├── comment.js          # 评论接口
│   │   ├── square.js           # 广场接口
│   │   ├── game.js             # 游戏接口
│   │   └── ai.js               # AI接口
│   │
│   ├── pages/                  # 页面
│   │   ├── index/              # 首页
│   │   ├── poetry-list/        # 诗词列表
│   │   ├── poetry-detail/      # 诗词详情
│   │   ├── square/             # 广场
│   │   ├── game/               # 飞花令游戏
│   │   └── profile/            # 个人中心
│   │
│   ├── components/             # 组件
│   │   ├── poetry-card/        # 诗词卡片
│   │   ├── comment-list/       # 评论列表
│   │   └── game-room/          # 游戏房间
│   │
│   ├── store/                  # Pinia状态管理
│   │   ├── user.js
│   │   ├── poetry.js
│   │   └── game.js
│   │
│   ├── utils/                  # 工具函数
│   │   ├── auth.js
│   │   ├── storage.js
│   │   └── websocket.js
│   │
│   ├── static/                 # 静态资源
│   ├── App.vue
│   ├── main.js
│   ├── manifest.json
│   └── pages.json
│
├── package.json
└── vite.config.js
```

### 3.3 管理后台目录 (admin-web/)

```
admin-web/  (Vue 3 + Element Plus)
├── src/
│   ├── api/                    # API接口
│   │   ├── request.js
│   │   ├── user.js
│   │   ├── poetry.js
│   │   ├── content.js
│   │   └── statistics.js
│   │
│   ├── views/                  # 页面视图
│   │   ├── Dashboard/          # 仪表盘
│   │   ├── User/               # 用户管理
│   │   ├── Poetry/             # 诗词管理
│   │   ├── Content/            # 内容管理
│   │   ├── System/             # 系统管理
│   │   └── Auth/               # 登录页
│   │
│   ├── components/             # 公共组件
│   ├── layout/                 # 布局组件
│   ├── router/                 # 路由配置
│   ├── store/                  # 状态管理
│   ├── utils/                  # 工具函数
│   ├── App.vue
│   └── main.js
│
├── package.json
└── vite.config.js
```

### 3.4 后端服务目录 (server/)

```
server/  (Python FastAPI)
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI应用入口
│   │
│   ├── core/                   # 核心配置
│   │   ├── __init__.py
│   │   ├── config.py           # 配置管理
│   │   ├── security.py         # 安全模块
│   │   └── database.py         # 数据库连接
│   │
│   ├── models/                 # 数据模型 (SQLAlchemy)
│   │   ├── __init__.py
│   │   ├── user.py             # 用户模型
│   │   ├── poetry.py           # 诗词模型
│   │   ├── author.py           # 作者模型
│   │   ├── comment.py          # 评论模型
│   │   ├── post.py             # 广场内容模型
│   │   ├── like.py             # 点赞模型
│   │   ├── collect.py          # 收藏模型
│   │   ├── follow.py           # 关注模型
│   │   ├── game.py             # 游戏模型
│   │   └── message.py          # 消息模型
│   │
│   ├── schemas/                # Pydantic模型 (API验证)
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── poetry.py
│   │   ├── comment.py
│   │   ├── post.py
│   │   └── ai.py               # AI相关Schema
│   │
│   ├── api/                    # API路由
│   │   ├── __init__.py
│   │   ├── deps.py             # 依赖注入
│   │   └── v1/                 # API版本1
│   │       ├── __init__.py
│   │       ├── auth.py         # 认证接口
│   │       ├── users.py        # 用户接口
│   │       ├── poetry.py       # 诗词接口
│   │       ├── comments.py     # 评论接口
│   │       ├── square.py       # 广场接口
│   │       ├── game.py         # 游戏接口
│   │       ├── messages.py     # 消息接口
│   │       ├── search.py       # 搜索接口
│   │       ├── ai.py           # AI接口 ✨
│   │       └── admin.py        # 管理接口
│   │
│   ├── services/               # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── user_service.py
│   │   ├── poetry_service.py
│   │   ├── comment_service.py
│   │   ├── search_service.py   # Elasticsearch搜索
│   │   ├── wechat_service.py   # 微信服务
│   │   ├── upload_service.py   # 上传服务
│   │   └── ai_service.py       # AI服务 ✨
│   │       ├── tongyi.py       # 通义千问集成
│   │       ├── wenxin.py       # 文心一言集成
│   │       ├── recommender.py  # 推荐算法
│   │       └── cache.py        # AI结果缓存
│   │
│   ├── tasks/                  # Celery异步任务
│   │   ├── __init__.py
│   │   ├── celery_app.py
│   │   ├── ai_tasks.py         # AI异步任务
│   │   └── schedule_tasks.py   # 定时任务
│   │
│   ├── websocket/              # WebSocket
│   │   ├── __init__.py
│   │   ├── manager.py
│   │   └── game_handler.py
│   │
│   ├── utils/                  # 工具函数
│   │   ├── __init__.py
│   │   ├── wechat.py
│   │   ├── redis_client.py
│   │   ├── oss.py
│   │   └── helpers.py
│   │
│   └── middleware/             # 中间件
│       ├── __init__.py
│       ├── cors.py
│       ├── rate_limit.py
│       └── logging.py
│
├── alembic/                    # 数据库迁移
│   ├── versions/
│   └── env.py
│
├── tests/                      # 测试
│   ├── test_api/
│   ├── test_services/
│   └── conftest.py
│
├── scripts/                    # 脚本
│   ├── import_poetry.py        # 导入诗词数据
│   └── init_db.py              # 初始化数据库
│
├── requirements.txt            # 依赖包
├── .env                        # 环境变量
├── .env.example
├── Dockerfile
├── docker-compose.yml
└── README.md
```

---

## 四、接口规范

### 4.1 RESTful API规范

#### 基础规范

- **协议**: HTTPS
- **域名**: `api.xingyu-poetry.com`
- **版本**: 通过URL路径标识 `/api/v1/`
- **格式**: JSON
- **编码**: UTF-8

#### URL设计规范

```
# 资源命名使用复数名词
GET    /api/v1/poetries          # 获取诗词列表
GET    /api/v1/poetries/{id}     # 获取诗词详情
POST   /api/v1/poetries          # 创建诗词
PUT    /api/v1/poetries/{id}     # 更新诗词
DELETE /api/v1/poetries/{id}     # 删除诗词

# 子资源
GET    /api/v1/poetries/{id}/comments     # 获取诗词的评论
POST   /api/v1/poetries/{id}/like         # 点赞诗词
POST   /api/v1/poetries/{id}/collect      # 收藏诗词

# 操作动词使用POST
POST   /api/v1/auth/login          # 登录
POST   /api/v1/auth/logout         # 登出
POST   /api/v1/ai/generate         # AI生成诗词
```

#### HTTP状态码

| 状态码 | 说明 | 使用场景 |
|--------|------|---------|
| `200` | OK | 成功 |
| `201` | Created | 创建成功 |
| `204` | No Content | 删除成功 |
| `400` | Bad Request | 参数错误 |
| `401` | Unauthorized | 未认证 |
| `403` | Forbidden | 无权限 |
| `404` | Not Found | 资源不存在 |
| `422` | Unprocessable Entity | 参数验证失败 |
| `429` | Too Many Requests | 请求过多 |
| `500` | Internal Server Error | 服务器错误 |

#### 统一响应格式

**成功响应**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1,
    "title": "静夜思",
    "content": "床前明月光..."
  }
}
```

**错误响应**:
```json
{
  "code": 40001,
  "message": "参数验证失败",
  "errors": {
    "title": ["标题不能为空"]
  }
}
```

**分页响应**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [...],
    "total": 100,
    "page": 1,
    "page_size": 20,
    "total_pages": 5
  }
}
```

### 4.2 核心接口列表

#### 认证接口

```python
# POST /api/v1/auth/login/wechat
# 微信小程序登录
{
  "code": "wx_code_from_wx.login",
  "encrypted_data": "...",
  "iv": "..."
}

# POST /api/v1/auth/login/password
# 账号密码登录
{
  "username": "user123",
  "password": "password123"
}

# POST /api/v1/auth/refresh
# 刷新Token
{
  "refresh_token": "..."
}
```

#### 诗词接口

```python
# GET /api/v1/poetries?page=1&page_size=20&dynasty=唐代
# 获取诗词列表

# GET /api/v1/poetries/{id}
# 获取诗词详情

# GET /api/v1/poetries/random
# 随机获取诗词

# GET /api/v1/poetries/recommend
# 获取推荐诗词
```

#### AI接口

```python
# POST /api/v1/ai/generate-poetry
# AI生成诗词
{
  "prompt": "明月",
  "style": "五言绝句",
  "dynasty": "唐代"
}

# POST /api/v1/ai/analyze-poetry
# AI分析诗词
{
  "poetry_id": 123
}

# POST /api/v1/ai/qa
# AI问答
{
  "question": "李白写过哪些有名的诗?"
}
```

#### 游戏接口

```python
# POST /api/v1/game/rooms
# 创建游戏房间
{
  "keyword": "春",
  "time_limit": 60
}

# WebSocket /ws/game/{room_id}
# 游戏WebSocket连接
```

### 4.3 认证机制

#### JWT Token

**Header**:
```
Authorization: Bearer <access_token>
```

**Token结构**:
```json
{
  "user_id": 123,
  "username": "user123",
  "exp": 1699999999,
  "type": "access"
}
```

**Token有效期**:
- Access Token: 7天
- Refresh Token: 30天

---

## 五、代码规范

### 5.1 Python代码规范

#### 基础规范

- **编码**: UTF-8
- **换行符**: LF (Unix)
- **缩进**: 4个空格
- **行宽**: 最大88字符 (Black默认)
- **引号**: 双引号优先

#### 命名规范

```python
# 变量和函数: snake_case
user_name = "张三"
def get_poetry_list():
    pass

# 类: PascalCase
class PoetryService:
    pass

# 常量: UPPER_SNAKE_CASE
MAX_RETRY_COUNT = 3

# 私有变量和方法: 前缀单下划线
_internal_cache = {}
def _private_method():
    pass

# 模块: snake_case
# user_service.py
# poetry_manager.py
```

#### 类型注解

```python
from typing import Optional, List, Dict, Any

def get_poetry(poetry_id: int) -> Optional[Dict[str, Any]]:
    """
    获取诗词详情

    Args:
        poetry_id: 诗词ID

    Returns:
        诗词信息字典,不存在返回None
    """
    pass

async def get_poetries(
    page: int = 1,
    page_size: int = 20,
    dynasty: Optional[str] = None
) -> List[Dict[str, Any]]:
    """获取诗词列表"""
    pass
```

#### 文档字符串

```python
def complex_function(param1: str, param2: int) -> Dict[str, Any]:
    """
    函数简短描述

    详细描述函数功能和用法...

    Args:
        param1: 参数1说明
        param2: 参数2说明

    Returns:
        返回值说明

    Raises:
        ValueError: 参数错误时抛出

    Examples:
        >>> complex_function("test", 123)
        {"result": "success"}
    """
    pass
```

#### FastAPI路由规范

```python
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession

from app.api.deps import get_db, get_current_user
from app.schemas.poetry import PoetryCreate, PoetryResponse
from app.services.poetry_service import PoetryService

router = APIRouter(prefix="/poetries", tags=["诗词"])

@router.get("/", response_model=List[PoetryResponse])
async def get_poetries(
    page: int = 1,
    page_size: int = 20,
    dynasty: Optional[str] = None,
    db: AsyncSession = Depends(get_db)
):
    """
    获取诗词列表

    - **page**: 页码
    - **page_size**: 每页数量
    - **dynasty**: 朝代筛选
    """
    service = PoetryService(db)
    poetries = await service.get_list(page, page_size, dynasty)
    return poetries

@router.post("/", response_model=PoetryResponse, status_code=status.HTTP_201_CREATED)
async def create_poetry(
    poetry: PoetryCreate,
    db: AsyncSession = Depends(get_db),
    current_user = Depends(get_current_user)
):
    """创建诗词"""
    service = PoetryService(db)
    return await service.create(poetry)
```

#### 错误处理

```python
from fastapi import HTTPException, status

# 使用HTTPException
if not poetry:
    raise HTTPException(
        status_code=status.HTTP_404_NOT_FOUND,
        detail="诗词不存在"
    )

# 自定义异常
class PoetryNotFoundError(Exception):
    """诗词不存在异常"""
    pass

# 异常处理器
from fastapi import Request
from fastapi.responses import JSONResponse

@app.exception_handler(PoetryNotFoundError)
async def poetry_not_found_handler(request: Request, exc: PoetryNotFoundError):
    return JSONResponse(
        status_code=404,
        content={"code": 40401, "message": "诗词不存在"}
    )
```

### 5.2 Vue代码规范

#### 命名规范

```javascript
// 组件: PascalCase
PoetryCard.vue
CommentList.vue

// 文件: kebab-case
poetry-service.js
user-utils.js

// 变量和函数: camelCase
const poetryList = []
function getPoetryDetail() {}

// 常量: UPPER_SNAKE_CASE
const MAX_RETRY_COUNT = 3
```

#### 组件结构

```vue
<template>
  <div class="poetry-card">
    <!-- 模板内容 -->
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { usePoetryStore } from '@/store/poetry'

// Props定义
const props = defineProps({
  poetryId: {
    type: Number,
    required: true
  }
})

// Emits定义
const emit = defineEmits(['update', 'delete'])

// 响应式数据
const poetry = ref(null)

// 计算属性
const formattedContent = computed(() => {
  return poetry.value?.content.split('\n')
})

// 方法
function handleLike() {
  emit('update', poetry.value.id)
}

// 生命周期
onMounted(async () => {
  poetry.value = await fetchPoetry(props.poetryId)
})
</script>

<style scoped lang="scss">
.poetry-card {
  // 样式
}
</style>
```

#### API调用规范

```javascript
// api/poetry.js
import request from '@/utils/request'

export const poetryApi = {
  // 获取列表
  getList: (params) => {
    return request.get('/api/v1/poetries', { params })
  },

  // 获取详情
  getDetail: (id) => {
    return request.get(`/api/v1/poetries/${id}`)
  },

  // 创建
  create: (data) => {
    return request.post('/api/v1/poetries', data)
  }
}

// 使用
import { poetryApi } from '@/api/poetry'

async function loadPoetries() {
  try {
    const res = await poetryApi.getList({ page: 1, page_size: 20 })
    poetries.value = res.data.items
  } catch (error) {
    console.error('加载失败', error)
  }
}
```

### 5.3 Git提交规范

#### Commit Message格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

#### Type类型

- `feat`: 新功能
- `fix`: Bug修复
- `docs`: 文档更新
- `style`: 代码格式(不影响代码运行)
- `refactor`: 重构
- `perf`: 性能优化
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动

#### 示例

```
feat(poetry): 添加诗词搜索功能

- 实现关键词搜索
- 支持朝代筛选
- 添加搜索历史

Closes #123
```

### 5.4 代码审查检查清单

- [ ] 代码符合命名规范
- [ ] 添加了必要的注释和文档字符串
- [ ] 添加了类型注解(Python)
- [ ] 错误处理完善
- [ ] 敏感信息未硬编码
- [ ] 数据库查询已优化
- [ ] API接口已添加认证和权限检查
- [ ] 添加了单元测试
- [ ] 通过了代码静态检查(ruff/mypy)
- [ ] 通过了格式化检查(black/prettier)

---

## 六、数据库设计

### 6.1 MySQL表设计

#### 用户表 (users)

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    openid VARCHAR(100) UNIQUE COMMENT '微信openid',
    unionid VARCHAR(100) COMMENT '微信unionid',
    username VARCHAR(50) UNIQUE COMMENT '用户名',
    password VARCHAR(255) COMMENT '密码(bcrypt加密)',
    nickname VARCHAR(50) NOT NULL COMMENT '昵称',
    avatar VARCHAR(500) COMMENT '头像URL',
    phone VARCHAR(20) COMMENT '手机号',
    gender TINYINT DEFAULT 0 COMMENT '性别:0未知,1男,2女',
    intro VARCHAR(500) COMMENT '个人简介',
    level INT DEFAULT 1 COMMENT '用户等级',
    exp INT DEFAULT 0 COMMENT '经验值',
    status TINYINT DEFAULT 1 COMMENT '状态:1正常,2封禁',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    last_login_at DATETIME COMMENT '最后登录时间',

    INDEX idx_username (username),
    INDEX idx_phone (phone),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

#### 诗词表 (poetries)

```sql
CREATE TABLE poetries (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '诗词ID',
    title VARCHAR(100) NOT NULL COMMENT '标题',
    content TEXT NOT NULL COMMENT '内容',
    author_id BIGINT COMMENT '作者ID',
    dynasty VARCHAR(50) COMMENT '朝代',
    type VARCHAR(50) COMMENT '类型:绝句,律诗,词等',
    tags JSON COMMENT '标签',
    translation TEXT COMMENT '翻译',
    annotation TEXT COMMENT '注释',
    appreciation TEXT COMMENT '赏析',
    background TEXT COMMENT '创作背景',
    read_count INT DEFAULT 0 COMMENT '阅读数',
    like_count INT DEFAULT 0 COMMENT '点赞数',
    comment_count INT DEFAULT 0 COMMENT '评论数',
    collect_count INT DEFAULT 0 COMMENT '收藏数',
    status TINYINT DEFAULT 1 COMMENT '状态:1已发布,2草稿,3已删除',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_author_id (author_id),
    INDEX idx_dynasty (dynasty),
    INDEX idx_type (type),
    INDEX idx_status (status),
    FULLTEXT idx_content (title, content) WITH PARSER ngram
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='诗词表';
```

#### 作者表 (authors)

```sql
CREATE TABLE authors (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '作者ID',
    name VARCHAR(50) NOT NULL COMMENT '姓名',
    dynasty VARCHAR(50) COMMENT '朝代',
    intro TEXT COMMENT '简介',
    avatar VARCHAR(500) COMMENT '头像',
    birth_year INT COMMENT '出生年份',
    death_year INT COMMENT '逝世年份',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_dynasty (dynasty)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='作者表';
```

#### 评论表 (comments)

```sql
CREATE TABLE comments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '评论ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    target_type VARCHAR(20) NOT NULL COMMENT '目标类型:poetry,post',
    target_id BIGINT NOT NULL COMMENT '目标ID',
    parent_id BIGINT COMMENT '父评论ID',
    content TEXT NOT NULL COMMENT '评论内容',
    like_count INT DEFAULT 0 COMMENT '点赞数',
    reply_count INT DEFAULT 0 COMMENT '回复数',
    status TINYINT DEFAULT 1 COMMENT '状态:1正常,2已删除',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_user_id (user_id),
    INDEX idx_target (target_type, target_id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评论表';
```

#### 点赞表 (likes)

```sql
CREATE TABLE likes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    target_type VARCHAR(20) NOT NULL COMMENT '目标类型:poetry,post,comment',
    target_id BIGINT NOT NULL COMMENT '目标ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uk_user_target (user_id, target_type, target_id),
    INDEX idx_target (target_type, target_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='点赞表';
```

#### 收藏表 (collects)

```sql
CREATE TABLE collects (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    target_type VARCHAR(20) NOT NULL COMMENT '目标类型:poetry,post',
    target_id BIGINT NOT NULL COMMENT '目标ID',
    category VARCHAR(50) COMMENT '收藏分类',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user_id (user_id),
    INDEX idx_target (target_type, target_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='收藏表';
```

#### 关注表 (follows)

```sql
CREATE TABLE follows (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '关注者ID',
    follow_user_id BIGINT NOT NULL COMMENT '被关注者ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uk_user_follow (user_id, follow_user_id),
    INDEX idx_follow_user_id (follow_user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='关注表';
```

#### 广场内容表 (posts)

```sql
CREATE TABLE posts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '内容ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    content TEXT NOT NULL COMMENT '内容',
    images JSON COMMENT '图片URLs',
    tags JSON COMMENT '标签',
    type VARCHAR(20) DEFAULT 'original' COMMENT '类型:original,share',
    like_count INT DEFAULT 0 COMMENT '点赞数',
    comment_count INT DEFAULT 0 COMMENT '评论数',
    collect_count INT DEFAULT 0 COMMENT '收藏数',
    view_count INT DEFAULT 0 COMMENT '浏览数',
    status TINYINT DEFAULT 0 COMMENT '状态:0待审核,1已发布,2已删除',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='广场内容表';
```

#### 游戏房间表 (game_rooms)

```sql
CREATE TABLE game_rooms (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '房间ID',
    room_type VARCHAR(20) NOT NULL COMMENT '房间类型:system,player',
    keyword VARCHAR(10) NOT NULL COMMENT '关键字',
    player1_id BIGINT COMMENT '玩家1 ID',
    player2_id BIGINT COMMENT '玩家2 ID',
    current_player TINYINT COMMENT '当前回合玩家:1或2',
    round INT DEFAULT 1 COMMENT '当前回合数',
    max_round INT DEFAULT 10 COMMENT '最大回合数',
    time_limit INT DEFAULT 60 COMMENT '回答时间限制(秒)',
    status TINYINT DEFAULT 0 COMMENT '状态:0等待中,1进行中,2已结束',
    winner_id BIGINT COMMENT '获胜者ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    started_at DATETIME COMMENT '开始时间',
    ended_at DATETIME COMMENT '结束时间',

    INDEX idx_status (status),
    INDEX idx_player1 (player1_id),
    INDEX idx_player2 (player2_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='游戏房间表';
```

#### 游戏记录表 (game_records)

```sql
CREATE TABLE game_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    room_id BIGINT NOT NULL COMMENT '房间ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    poetry_id BIGINT COMMENT '诗词ID',
    poetry_content VARCHAR(200) COMMENT '诗句内容',
    round INT NOT NULL COMMENT '回合数',
    is_correct TINYINT DEFAULT 1 COMMENT '是否正确',
    answer_time INT COMMENT '作答时间(秒)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_room_id (room_id),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='游戏记录表';
```

#### 消息表 (messages)

```sql
CREATE TABLE messages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '消息ID',
    user_id BIGINT NOT NULL COMMENT '接收用户ID',
    type VARCHAR(20) NOT NULL COMMENT '消息类型:system,interact,follow,private',
    title VARCHAR(100) COMMENT '标题',
    content TEXT COMMENT '内容',
    related_type VARCHAR(20) COMMENT '关联类型',
    related_id BIGINT COMMENT '关联ID',
    from_user_id BIGINT COMMENT '发送者ID(私信)',
    is_read TINYINT DEFAULT 0 COMMENT '是否已读:0未读,1已读',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user_id (user_id),
    INDEX idx_is_read (is_read),
    INDEX idx_type (type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='消息表';
```

### 6.2 Redis缓存设计

```python
# 缓存键命名规范
CACHE_KEYS = {
    # 用户相关
    "user:info:{user_id}": "用户信息",
    "user:token:{user_id}": "用户Token",

    # 诗词相关
    "poetry:detail:{poetry_id}": "诗词详情",
    "poetry:hot": "热门诗词列表",
    "poetry:random": "随机诗词池",

    # 统计相关
    "count:poetry:{poetry_id}:read": "诗词阅读数",
    "count:poetry:{poetry_id}:like": "诗词点赞数",

    # 排行榜
    "rank:poetry:hot": "诗词热度排行",
    "rank:user:level": "用户等级排行",

    # AI结果缓存
    "ai:generate:{hash}": "AI生成结果缓存",
    "ai:analyze:{poetry_id}": "AI分析结果缓存",

    # 限流
    "ratelimit:api:{ip}:{endpoint}": "API限流",
    "ratelimit:ai:{user_id}": "AI调用限流"
}

# 缓存过期时间(秒)
CACHE_TTL = {
    "user:info": 3600,          # 1小时
    "poetry:detail": 7200,      # 2小时
    "poetry:hot": 600,          # 10分钟
    "ai:generate": 86400,       # 1天
    "ratelimit:api": 60,        # 1分钟
}
```

### 6.3 Elasticsearch索引设计

```json
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "ik_smart_analyzer": {
          "type": "ik_smart"
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id": { "type": "long" },
      "title": {
        "type": "text",
        "analyzer": "ik_smart_analyzer",
        "fields": {
          "keyword": { "type": "keyword" }
        }
      },
      "content": {
        "type": "text",
        "analyzer": "ik_smart_analyzer"
      },
      "author": {
        "type": "text",
        "analyzer": "ik_smart_analyzer",
        "fields": {
          "keyword": { "type": "keyword" }
        }
      },
      "dynasty": { "type": "keyword" },
      "type": { "type": "keyword" },
      "tags": { "type": "keyword" },
      "read_count": { "type": "integer" },
      "like_count": { "type": "integer" },
      "created_at": { "type": "date" }
    }
  }
}
```

---

## 七、开发环境配置

### 7.1 Python后端环境

#### 安装Python 3.11

```bash
# 使用pyenv安装(推荐)
curl https://pyenv.run | bash
pyenv install 3.11.6
pyenv global 3.11.6
```

#### 创建虚拟环境

```bash
cd server/
python -m venv venv

# 激活虚拟环境
# Linux/Mac
source venv/bin/activate
# Windows
venv\Scripts\activate
```

#### 安装依赖

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

#### 配置环境变量

```bash
cp .env.example .env
```

**.env文件**:
```ini
# 应用配置
APP_NAME=星语诗词平台
APP_ENV=development
DEBUG=True
SECRET_KEY=your-secret-key-change-in-production

# 数据库配置
DATABASE_URL=mysql+aiomysql://root:password@localhost:3306/poetry_db
REDIS_URL=redis://localhost:6379/0
ELASTICSEARCH_URL=http://localhost:9200

# JWT配置
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=10080  # 7天

# 微信配置
WECHAT_APPID=your-wechat-appid
WECHAT_SECRET=your-wechat-secret

# 阿里云OSS配置
OSS_ACCESS_KEY_ID=your-oss-access-key
OSS_ACCESS_KEY_SECRET=your-oss-secret
OSS_BUCKET=your-bucket-name
OSS_ENDPOINT=oss-cn-hangzhou.aliyuncs.com

# AI服务配置
AI_PROVIDER=tongyi  # tongyi, wenxin

# 通义千问配置
TONGYI_API_KEY=your-tongyi-api-key
TONGYI_MODEL=qwen-turbo

# 文心一言配置(备用)
WENXIN_API_KEY=your-wenxin-api-key
WENXIN_SECRET_KEY=your-wenxin-secret
```

#### 初始化数据库

```bash
# 数据库迁移
alembic upgrade head

# 导入初始数据
python scripts/init_db.py
python scripts/import_poetry.py
```

#### 启动服务

```bash
# 启动FastAPI服务
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 启动Celery Worker
celery -A app.tasks.celery_app worker --loglevel=info

# 启动Celery Beat(定时任务)
celery -A app.tasks.celery_app beat --loglevel=info
```

### 7.2 前端环境

#### 用户端(uni-app)

```bash
cd client-app/

# 安装依赖
npm install

# 开发模式
npm run dev:mp-weixin    # 微信小程序
npm run dev:h5           # H5

# 构建
npm run build:mp-weixin
npm run build:h5
```

#### 管理后台

```bash
cd admin-web/

# 安装依赖
npm install

# 开发模式
npm run dev

# 构建
npm run build
```

### 7.3 数据库环境

#### MySQL

```bash
# Docker启动
docker run -d \
  --name poetry-mysql \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=password \
  -e MYSQL_DATABASE=poetry_db \
  -v mysql_data:/var/lib/mysql \
  mysql:8.0
```

#### Redis

```bash
docker run -d \
  --name poetry-redis \
  -p 6379:6379 \
  -v redis_data:/data \
  redis:7-alpine
```

#### Elasticsearch

```bash
docker run -d \
  --name poetry-es \
  -p 9200:9200 \
  -e "discovery.type=single-node" \
  -e "xpack.security.enabled=false" \
  -v es_data:/usr/share/elasticsearch/data \
  elasticsearch:7.17.9
```

### 7.4 开发工具

#### VS Code插件

```json
{
  "recommendations": [
    "ms-python.python",
    "ms-python.vscode-pylance",
    "ms-python.black-formatter",
    "charliermarsh.ruff",
    "Vue.volar",
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "eamodio.gitlens"
  ]
}
```

#### VS Code设置

```json
{
  "python.linting.enabled": true,
  "python.linting.ruffEnabled": true,
  "python.formatting.provider": "black",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  }
}
```

---

## 八、开发流程

### 8.1 分支管理策略

```
main (master)        # 主分支,生产环境
  ├── develop        # 开发分支
  │    ├── feature/xxx  # 功能分支
  │    ├── bugfix/xxx   # Bug修复分支
  │    └── hotfix/xxx   # 紧急修复分支
  └── release/v1.0   # 发布分支
```

#### 分支命名规范

```bash
# 功能开发
feature/user-auth
feature/poetry-search

# Bug修复
bugfix/login-error
bugfix/poetry-display

# 紧急修复
hotfix/security-patch

# 发布
release/v1.0.0
```

### 8.2 开发工作流

1. **创建功能分支**
```bash
git checkout develop
git pull origin develop
git checkout -b feature/poetry-search
```

2. **开发功能**
```bash
# 编写代码
# 编写测试
# 运行测试
pytest tests/
```

3. **提交代码**
```bash
git add .
git commit -m "feat(poetry): 实现诗词搜索功能"
```

4. **推送并创建PR**
```bash
git push origin feature/poetry-search
# 在GitHub创建Pull Request
```

5. **代码审查**
- 团队成员审查代码
- CI/CD自动运行测试
- 通过后合并到develop分支

6. **发布**
```bash
# 从develop创建release分支
git checkout -b release/v1.0.0 develop

# 修复发现的问题
# 合并到main和develop
git checkout main
git merge release/v1.0.0
git tag -a v1.0.0 -m "Release v1.0.0"
git push --tags

git checkout develop
git merge release/v1.0.0
```

### 8.3 测试规范

#### 单元测试

```python
# tests/test_services/test_poetry_service.py
import pytest
from app.services.poetry_service import PoetryService

@pytest.mark.asyncio
async def test_get_poetry_list(db_session):
    """测试获取诗词列表"""
    service = PoetryService(db_session)
    poetries = await service.get_list(page=1, page_size=10)

    assert len(poetries) > 0
    assert poetries[0].title is not None

@pytest.mark.asyncio
async def test_get_poetry_detail(db_session):
    """测试获取诗词详情"""
    service = PoetryService(db_session)
    poetry = await service.get_detail(1)

    assert poetry is not None
    assert poetry.id == 1
```

#### API测试

```python
# tests/test_api/test_poetry.py
import pytest
from httpx import AsyncClient

@pytest.mark.asyncio
async def test_get_poetries(client: AsyncClient):
    """测试诗词列表接口"""
    response = await client.get("/api/v1/poetries")

    assert response.status_code == 200
    data = response.json()
    assert data["code"] == 0
    assert "items" in data["data"]
```

#### 测试覆盖率

```bash
# 运行测试并生成覆盖率报告
pytest --cov=app --cov-report=html

# 查看覆盖率报告
open htmlcov/index.html
```

### 8.4 CI/CD流程

#### GitHub Actions配置

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd server/
        pip install -r requirements.txt

    - name: Run linters
      run: |
        cd server/
        ruff check app/
        black --check app/
        mypy app/

    - name: Run tests
      run: |
        cd server/
        pytest --cov=app

    - name: Upload coverage
      uses: codecov/codecov-action@v3
```

---

## 九、部署方案

### 9.1 Docker部署

#### docker-compose.yml

```yaml
version: '3.8'

services:
  # FastAPI应用
  api:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: poetry-api
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=mysql+aiomysql://root:password@mysql:3306/poetry_db
      - REDIS_URL=redis://redis:6379/0
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    depends_on:
      - mysql
      - redis
      - elasticsearch
    volumes:
      - ./server:/app
    restart: unless-stopped

  # Celery Worker
  celery_worker:
    build:
      context: ./server
    container_name: poetry-celery-worker
    command: celery -A app.tasks.celery_app worker --loglevel=info
    depends_on:
      - redis
      - mysql
    environment:
      - DATABASE_URL=mysql+aiomysql://root:password@mysql:3306/poetry_db
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./server:/app
    restart: unless-stopped

  # Celery Beat
  celery_beat:
    build:
      context: ./server
    container_name: poetry-celery-beat
    command: celery -A app.tasks.celery_app beat --loglevel=info
    depends_on:
      - redis
    environment:
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./server:/app
    restart: unless-stopped

  # MySQL
  mysql:
    image: mysql:8.0
    container_name: poetry-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=poetry_db
      - MYSQL_CHARACTER_SET_SERVER=utf8mb4
      - MYSQL_COLLATION_SERVER=utf8mb4_unicode_ci
    volumes:
      - mysql_data:/var/lib/mysql
    restart: unless-stopped

  # Redis
  redis:
    image: redis:7-alpine
    container_name: poetry-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

  # Elasticsearch
  elasticsearch:
    image: elasticsearch:7.17.9
    container_name: poetry-es
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    restart: unless-stopped

  # Nginx
  nginx:
    image: nginx:alpine
    container_name: poetry-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./admin-web/dist:/usr/share/nginx/html/admin
      - ./client-app/dist/h5:/usr/share/nginx/html/h5
    depends_on:
      - api
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
  es_data:
```

#### Dockerfile (server/)

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    default-libmysqlclient-dev \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 9.2 Nginx配置

```nginx
# deploy/nginx/nginx.conf
upstream api_backend {
    server api:8000;
}

server {
    listen 80;
    server_name api.xingyu-poetry.com;

    # API接口
    location /api/ {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket
    location /ws/ {
        proxy_pass http://api_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}

server {
    listen 80;
    server_name admin.xingyu-poetry.com;

    root /usr/share/nginx/html/admin;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }
}

server {
    listen 80;
    server_name h5.xingyu-poetry.com;

    root /usr/share/nginx/html/h5;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### 9.3 部署脚本

```bash
#!/bin/bash
# deploy/scripts/deploy.sh

set -e

echo "开始部署..."

# 拉取最新代码
git pull origin main

# 构建后端Docker镜像
cd server/
docker build -t poetry-api:latest .
cd ..

# 构建前端
cd admin-web/
npm install
npm run build
cd ..

cd client-app/
npm install
npm run build:h5
cd ..

# 重启服务
docker-compose down
docker-compose up -d

echo "部署完成!"
```

### 9.4 服务器配置建议

#### 开发/测试环境

- **配置**: 2核4G
- **成本**: ~100-200元/月
- **适用**: 开发测试、小规模演示

#### 生产环境(小规模)

- **Web服务器**: 2核4G + 40GB SSD
- **数据库服务器**: 2核4G + 100GB SSD
- **成本**: ~300-400元/月
- **适用**: 初期运营,日活<1000

#### 生产环境(中规模)

- **Web服务器**: 4核8G (2台) + 负载均衡
- **数据库**: 4核8G + 500GB SSD
- **Redis**: 2核4G
- **成本**: ~1000-1500元/月
- **适用**: 日活1000-10000

---

## 十、开发排期

### 10.1 第一阶段:基础功能开发 (4-6周)

#### Week 1-2: 项目搭建与用户模块

**后端**:
- [ ] 搭建FastAPI项目框架
- [ ] 配置数据库(MySQL + Redis)
- [ ] 实现用户认证(微信登录、密码登录)
- [ ] 实现JWT Token机制
- [ ] 用户CRUD接口

**前端**:
- [ ] 搭建uni-app项目
- [ ] 配置路由和状态管理
- [ ] 实现登录页面
- [ ] 实现个人中心页面

#### Week 3-4: 诗词模块

**后端**:
- [ ] 诗词CRUD接口
- [ ] 诗词列表(分页、筛选)
- [ ] 诗词详情
- [ ] 配置Elasticsearch
- [ ] 实现诗词搜索
- [ ] 导入诗词数据

**前端**:
- [ ] 首页诗词推荐
- [ ] 诗词列表页
- [ ] 诗词详情页
- [ ] 搜索功能

#### Week 5-6: 互动模块

**后端**:
- [ ] 点赞功能
- [ ] 收藏功能
- [ ] 评论系统(一级、二级)
- [ ] 阅读统计

**前端**:
- [ ] 点赞交互
- [ ] 收藏交互
- [ ] 评论列表
- [ ] 评论发表

**测试与优化**:
- [ ] 单元测试
- [ ] API测试
- [ ] 性能优化

### 10.2 第二阶段:AI功能集成 (2-3周)

#### Week 7-8: AI接口集成

**后端**:
- [ ] 集成阿里云通义千问API
- [ ] 实现AI诗词生成
- [ ] 实现AI诗词分析
- [ ] 实现AI问答
- [ ] AI结果缓存机制
- [ ] AI调用限流

**前端**:
- [ ] AI生成诗词页面
- [ ] AI分析展示
- [ ] AI问答界面

#### Week 9: 推荐系统

**后端**:
- [ ] 基础推荐算法(协同过滤)
- [ ] 热门推荐
- [ ] 每日推荐
- [ ] 个性化推荐

**前端**:
- [ ] 推荐内容展示

### 10.3 第三阶段:社交与游戏 (3-4周)

#### Week 10-11: 广场功能

**后端**:
- [ ] 广场内容CRUD
- [ ] 内容审核
- [ ] 话题标签
- [ ] 内容推荐

**前端**:
- [ ] 广场页面
- [ ] 内容发布
- [ ] 话题浏览

#### Week 12-13: 飞花令游戏

**后端**:
- [ ] 游戏房间管理
- [ ] WebSocket实时通信
- [ ] 游戏逻辑(回合、判定)
- [ ] 游戏记录
- [ ] AI对手

**前端**:
- [ ] 游戏大厅
- [ ] 游戏房间
- [ ] 实时对战界面
- [ ] 游戏结果

### 10.4 第四阶段:管理后台 (2-3周)

#### Week 14-15: 管理后台开发

**后端**:
- [ ] 管理员认证
- [ ] 用户管理接口
- [ ] 内容管理接口
- [ ] 统计接口

**前端**:
- [ ] 管理后台框架
- [ ] 用户管理页面
- [ ] 诗词管理页面
- [ ] 内容审核页面
- [ ] 数据统计页面

### 10.5 第五阶段:测试与上线 (2-3周)

#### Week 16-17: 测试

- [ ] 功能测试
- [ ] 性能测试
- [ ] 安全测试
- [ ] 兼容性测试
- [ ] Bug修复

#### Week 18: 部署上线

- [ ] 服务器配置
- [ ] 域名配置
- [ ] SSL证书
- [ ] Docker部署
- [ ] 监控配置
- [ ] 备份策略
- [ ] 小程序提审

---

## 十一、附录

### 11.1 常用命令

```bash
# 后端
cd server/
source venv/bin/activate
uvicorn app.main:app --reload
celery -A app.tasks.celery_app worker --loglevel=info
pytest tests/

# 前端
cd client-app/
npm run dev:mp-weixin
npm run build:h5

cd admin-web/
npm run dev
npm run build

# Docker
docker-compose up -d
docker-compose down
docker-compose logs -f api

# 数据库
# 迁移
alembic upgrade head
alembic revision --autogenerate -m "描述"
# 备份
mysqldump -u root -p poetry_db > backup.sql
```

### 11.2 资源链接

**文档**:
- FastAPI: https://fastapi.tiangolo.com/zh/
- uni-app: https://uniapp.dcloud.net.cn/
- Vue 3: https://cn.vuejs.org/
- Element Plus: https://element-plus.org/zh-CN/

**AI服务**:
- 阿里云通义千问: https://dashscope.aliyun.com/
- 百度文心一言: https://cloud.baidu.com/product/wenxinworkshop

**数据资源**:
- 古诗词数据: https://github.com/chinese-poetry/chinese-poetry

### 11.3 团队协作

**沟通工具**:
- 飞书/钉钉: 日常沟通
- Slack/Discord: 技术讨论

**项目管理**:
- Jira/禅道: 任务管理
- Confluence/语雀: 文档协作

**代码托管**:
- GitHub/GitLab: 代码仓库
- 代码审查流程

**设计协作**:
- Figma/蓝湖: UI设计

---

## 总结

本开发计划提供了诗词平台的完整技术方案,包括:

✅ **明确的技术栈和版本**: Python 3.11 + FastAPI + MySQL + 第三方AI API
✅ **清晰的项目结构**: 前后端分离,模块化设计
✅ **规范的接口设计**: RESTful API + 统一响应格式
✅ **严格的代码规范**: Python/Vue代码规范 + Git提交规范
✅ **完整的数据库设计**: MySQL表结构 + Redis缓存 + ES索引
✅ **详细的开发环境配置**: Docker化部署方案
✅ **清晰的开发流程**: Git工作流 + CI/CD
✅ **合理的开发排期**: 18周完整开发周期

**关键特性**:
- 调用第三方AI API(阿里云通义千问),无需本地部署模型
- 大幅降低开发和运维成本(~200元/月)
- FastAPI高性能异步框架
- uni-app一套代码多端运行
- 完整的测试和部署方案

**下一步**:
1. 申请通义千问API密钥
2. 搭建开发环境
3. 开始第一阶段开发

---

**版本**: v1.0
**最后更新**: 2025-11-06
**维护者**: 星语开发团队
