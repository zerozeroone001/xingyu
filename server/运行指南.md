# 星语诗词平台 - 运行指南

## 方式一：使用 Docker Compose（推荐）

### 1. 启动所有服务

```bash
cd /home/user/xingyu
docker-compose up -d
```

**已修复端口冲突问题：** Redis 现在使用 6380 端口（原 6379 已被占用）

### 2. 查看服务状态

```bash
docker-compose ps
```

### 3. 查看日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f api
docker-compose logs -f mysql
docker-compose logs -f redis
```

### 4. 停止服务

```bash
docker-compose down
```

### 5. 重启服务

```bash
docker-compose restart
```

---

## 方式二：本地开发运行

如果 Docker 不可用，可以本地直接运行：

### 前置要求

1. **Python 3.11+**
2. **MySQL 8.0+** （运行在 3306 端口）
3. **Redis 7.0+** （运行在 6379 端口）

### 启动步骤

#### 1. 配置环境变量

```bash
cd /home/user/xingyu/server
cp .env.example .env
```

编辑 `.env` 文件，配置数据库连接：

```env
# 数据库配置
DATABASE_URL=mysql+aiomysql://root:your_password@localhost:3306/poetry_db?charset=utf8mb4

# Redis配置
REDIS_URL=redis://localhost:6379/0

# JWT密钥
JWT_SECRET_KEY=your-secret-key-here
JWT_REFRESH_SECRET_KEY=your-refresh-secret-key-here
```

#### 2. 创建虚拟环境并安装依赖

```bash
cd /home/user/xingyu/server

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

#### 3. 创建数据库

登录 MySQL 创建数据库：

```sql
CREATE DATABASE poetry_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 4. 执行数据库迁移

```bash
cd /home/user/xingyu/server
source venv/bin/activate
alembic upgrade head
```

#### 5. 导入示例数据（可选）

```bash
python scripts/import_poetry.py
```

#### 6. 启动应用

**方法A：使用启动脚本**

```bash
cd /home/user/xingyu/server
./start_local.sh
```

**方法B：直接运行**

```bash
cd /home/user/xingyu/server
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

---

## 访问应用

启动成功后，访问：

- **API 文档（Swagger）**: http://localhost:8000/docs
- **API 文档（ReDoc）**: http://localhost:8000/redoc
- **健康检查**: http://localhost:8000/health
- **根路径**: http://localhost:8000/

---

## 常见问题

### Q1: 端口被占用

**问题：** `Bind for 0.0.0.0:6379 failed: port is already allocated`

**解决方案：**
- 已修改 `docker-compose.yml`，Redis 改用 6380 端口
- 或停止占用端口的服务：`sudo systemctl stop redis`
- 或修改 docker-compose.yml 中的端口映射

### Q2: 数据库连接失败

**检查清单：**
1. MySQL 服务是否启动
2. 数据库是否已创建
3. .env 中的数据库密码是否正确
4. 数据库端口是否正确（默认 3306）

### Q3: 模块导入错误

确保已激活虚拟环境：
```bash
source venv/bin/activate
```

### Q4: Alembic 迁移失败

检查数据库连接是否正常，然后：
```bash
# 查看当前版本
alembic current

# 查看历史
alembic history

# 重置并重新迁移
alembic downgrade base
alembic upgrade head
```

---

## 开发提示

### 热重载

使用 `--reload` 参数时，修改代码会自动重启服务：
```bash
uvicorn app.main:app --reload
```

### 查看路由

```bash
# 进入 Python shell
python
>>> from app.main import app
>>> for route in app.routes:
...     print(route.path)
```

### 数据库迁移工作流

```bash
# 1. 修改模型后，生成新的迁移文件
alembic revision --autogenerate -m "描述变更"

# 2. 检查生成的迁移文件
cat alembic/versions/xxx_描述变更.py

# 3. 应用迁移
alembic upgrade head

# 4. 回滚（如需要）
alembic downgrade -1
```

---

## 生产环境部署

生产环境建议使用：
- **Gunicorn + Uvicorn workers**
- **Nginx 反向代理**
- **Docker Compose 或 Kubernetes**
- **环境变量管理工具（如 docker secrets）**

示例启动命令：
```bash
gunicorn app.main:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000 \
  --access-logfile - \
  --error-logfile -
```
