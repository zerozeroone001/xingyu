# 诗词程序 - 开发需求文档

> **版本**：v1.0
> **更新时间**：2024-11-06
> **状态**：最终版，可直接用于开发

---

## 📋 文档说明

本文档为诗词程序的完整开发需求文档，包含：
- ✅ 最终技术选型
- ✅ 项目目录结构设计
- ✅ 页面设计规范
- ✅ 完整API接口文档
- ✅ 数据库设计
- ✅ AI模型接入方案

**开发人员应严格按照本文档进行开发。**

---

# 第一部分：技术选型

## 1.1 技术架构总览

```
┌─────────────────────────────────────────┐
│          前端层                          │
├─────────────────────────────────────────┤
│  用户端: uni-app (Vue 3 + TypeScript)   │
│  管理端: Vue 3 + Element Plus + Vite    │
└─────────────────────────────────────────┘
              ↓ HTTP/HTTPS + WebSocket
┌─────────────────────────────────────────┐
│          后端层 (Python)                 │
├─────────────────────────────────────────┤
│  框架: FastAPI 0.104+                   │
│  ORM: SQLAlchemy 2.0 (异步)             │
│  任务队列: Celery + Redis               │
│  实时通信: WebSocket                    │
└─────────────────────────────────────────┘
              ↓ HTTP API
┌─────────────────────────────────────────┐
│          AI服务层                        │
├─────────────────────────────────────────┤
│  配置: URL + API Key                    │
│  厂商: 通义千问/文心一言/可配置         │
└─────────────────────────────────────────┘
              ↓ 数据存储
┌─────────────────────────────────────────┐
│          数据层                          │
├─────────────────────────────────────────┤
│  MySQL 8.0 (主数据库)                   │
│  Redis 6+ (缓存、会话、消息队列)        │
│  Elasticsearch 7+ (搜索引擎)            │
└─────────────────────────────────────────┘
```

## 1.2 前端技术栈

### 1.2.1 用户端（小程序 + H5）

**框架**：uni-app
- **版本**：3.0+
- **UI框架**：uView UI 3.0
- **构建工具**：Vite 4+
- **语言**：Vue 3 Composition API + TypeScript
- **状态管理**：Pinia 2+
- **HTTP客户端**：uni.request（封装）
- **路由**：uni-app内置路由

**目录结构**：
```
client-app/
├── src/
│   ├── pages/              # 页面
│   ├── components/         # 组件
│   ├── api/                # API接口
│   ├── store/              # Pinia状态管理
│   ├── utils/              # 工具函数
│   ├── static/             # 静态资源
│   ├── App.vue
│   ├── main.ts
│   ├── manifest.json       # 应用配置
│   └── pages.json          # 页面路由配置
├── package.json
└── vite.config.ts
```

### 1.2.2 管理端

**框架**：Vue 3 + Element Plus
- **版本**：Vue 3.3+, Element Plus 2.4+
- **构建工具**：Vite 4+
- **语言**：TypeScript 5+
- **路由**：Vue Router 4+
- **状态管理**：Pinia 2+
- **HTTP客户端**：Axios 1.4+
- **图表库**：ECharts 5+

## 1.3 后端技术栈

**核心框架**：
- **FastAPI**：0.104+ （Web框架）
- **Uvicorn**：0.24+ （ASGI服务器）
- **SQLAlchemy**：2.0+ （异步ORM）
- **Alembic**：1.12+ （数据库迁移）

**数据库**：
- **MySQL**：8.0+
- **Redis**：6.0+
- **Elasticsearch**：7.17+ （可选）

**异步任务**：
- **Celery**：5.3+
- **Redis**：消息队列

**认证**：
- **python-jose**：JWT Token
- **passlib**：密码加密

**HTTP客户端**：
- **httpx**：0.25+ （异步HTTP，用于调用AI API）

**完整依赖列表**：
```txt
# requirements.txt
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
aiomysql==0.2.0
alembic==1.12.1
redis==5.0.1
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
httpx==0.25.1
celery==5.3.4
pydantic==2.5.0
pydantic-settings==2.1.0
python-dotenv==1.0.0
python-multipart==0.0.6
```

## 1.4 AI模型接入方案 🤖

**接入方式**：通过配置文件统一管理

**配置示例**：
```python
# config.py
class Settings(BaseSettings):
    # AI服务配置
    AI_ENABLED: bool = True  # 是否启用AI功能
    AI_PROVIDER_URL: str = "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"
    AI_API_KEY: str = "sk-xxxxxxxxxxxxx"
    AI_MODEL: str = "qwen-turbo"  # 模型名称

    # 可选：多个AI服务配置
    AI_PROVIDERS: dict = {
        "tongyi": {
            "url": "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",
            "api_key": "sk-xxxxx",
            "model": "qwen-turbo"
        },
        "wenxin": {
            "url": "https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions",
            "api_key": "xxxxx",
            "secret_key": "xxxxx",
            "model": "ernie-bot-turbo"
        }
    }
```

**使用方式**：
```python
# 开发人员只需要在 .env 文件中配置
AI_PROVIDER_URL=https://dashscope.aliyuncs.com/api/v1/...
AI_API_KEY=sk-xxxxxxxxxxxxx
AI_MODEL=qwen-turbo
```

---

# 第二部分：项目目录结构

## 2.1 整体结构

```
poetry-platform/
├── client-app/          # 用户端（uni-app）
├── admin-web/           # 管理端（Vue 3）
├── server/              # 后端服务（FastAPI）
├── database/            # 数据库脚本
├── docs/                # 文档
└── deploy/              # 部署配置
```

## 2.2 用户端目录结构（client-app/）

```
client-app/
├── src/
│   ├── pages/                      # 页面
│   │   ├── index/                  # 首页
│   │   │   └── index.vue
│   │   ├── poetry/                 # 诗词模块
│   │   │   ├── list.vue           # 诗词列表
│   │   │   └── detail.vue         # 诗词详情
│   │   ├── square/                 # 广场模块
│   │   │   ├── index.vue          # 广场首页
│   │   │   └── post-detail.vue    # 内容详情
│   │   ├── game/                   # 飞花令游戏
│   │   │   ├── lobby.vue          # 游戏大厅
│   │   │   ├── room.vue           # 游戏房间
│   │   │   └── result.vue         # 游戏结果
│   │   ├── profile/                # 个人中心
│   │   │   ├── index.vue          # 个人主页
│   │   │   ├── collect.vue        # 我的收藏
│   │   │   ├── follow.vue         # 我的关注
│   │   │   ├── message.vue        # 站内消息
│   │   │   └── setting.vue        # 设置
│   │   ├── ai/                     # AI功能
│   │   │   ├── generate.vue       # AI生成诗词
│   │   │   └── analyze.vue        # 诗词分析
│   │   └── auth/                   # 认证
│   │       └── login.vue          # 登录
│   │
│   ├── components/                 # 组件
│   │   ├── common/                # 通用组件
│   │   │   ├── NavBar.vue
│   │   │   ├── TabBar.vue
│   │   │   └── Loading.vue
│   │   ├── poetry/                # 诗词组件
│   │   │   ├── PoetryCard.vue
│   │   │   └── PoetryList.vue
│   │   └── comment/               # 评论组件
│   │       ├── CommentList.vue
│   │       └── CommentInput.vue
│   │
│   ├── api/                        # API接口
│   │   ├── request.ts             # 请求封装
│   │   ├── auth.ts                # 认证接口
│   │   ├── poetry.ts              # 诗词接口
│   │   ├── comment.ts             # 评论接口
│   │   ├── square.ts              # 广场接口
│   │   ├── game.ts                # 游戏接口
│   │   └── ai.ts                  # AI接口
│   │
│   ├── store/                      # Pinia状态管理
│   │   ├── modules/
│   │   │   ├── user.ts
│   │   │   ├── poetry.ts
│   │   │   └── game.ts
│   │   └── index.ts
│   │
│   ├── utils/                      # 工具函数
│   │   ├── auth.ts                # 认证工具
│   │   ├── storage.ts             # 本地存储
│   │   ├── time.ts                # 时间处理
│   │   └── constants.ts           # 常量
│   │
│   ├── static/                     # 静态资源
│   │   ├── images/
│   │   └── icons/
│   │
│   ├── App.vue
│   ├── main.ts
│   ├── manifest.json
│   └── pages.json
│
├── package.json
├── tsconfig.json
├── vite.config.ts
└── README.md
```

## 2.3 后端目录结构（server/）

```
server/
├── app/
│   ├── __init__.py
│   ├── main.py                     # FastAPI应用入口
│   │
│   ├── core/                       # 核心配置
│   │   ├── __init__.py
│   │   ├── config.py              # 配置管理
│   │   ├── security.py            # JWT、密码加密
│   │   └── database.py            # 数据库连接
│   │
│   ├── models/                     # 数据模型（SQLAlchemy）
│   │   ├── __init__.py
│   │   ├── base.py                # 基础模型
│   │   ├── user.py                # 用户模型
│   │   ├── poetry.py              # 诗词模型
│   │   ├── comment.py             # 评论模型
│   │   ├── post.py                # 广场内容模型
│   │   ├── game.py                # 游戏模型
│   │   └── message.py             # 消息模型
│   │
│   ├── schemas/                    # Pydantic模型（API验证）
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── poetry.py
│   │   ├── comment.py
│   │   ├── post.py
│   │   ├── game.py
│   │   └── ai.py                  # AI请求/响应模型
│   │
│   ├── api/                        # API路由
│   │   ├── __init__.py
│   │   ├── deps.py                # 依赖注入
│   │   └── v1/                    # API v1版本
│   │       ├── __init__.py
│   │       ├── auth.py            # 认证接口
│   │       ├── users.py           # 用户接口
│   │       ├── poetry.py          # 诗词接口
│   │       ├── comments.py        # 评论接口
│   │       ├── square.py          # 广场接口
│   │       ├── game.py            # 游戏接口
│   │       ├── messages.py        # 消息接口
│   │       ├── search.py          # 搜索接口
│   │       ├── ai.py              # AI接口 🤖
│   │       └── admin.py           # 管理接口
│   │
│   ├── services/                   # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── user_service.py
│   │   ├── poetry_service.py
│   │   ├── comment_service.py
│   │   ├── square_service.py
│   │   ├── game_service.py
│   │   ├── search_service.py
│   │   └── ai_service.py          # AI服务 🤖
│   │       ├── base.py            # AI基础类
│   │       ├── provider.py        # AI提供商适配器
│   │       ├── generator.py       # 诗词生成
│   │       ├── analyzer.py        # 诗词分析
│   │       └── qa.py              # 智能问答
│   │
│   ├── tasks/                      # Celery异步任务
│   │   ├── __init__.py
│   │   ├── celery_app.py
│   │   ├── ai_tasks.py            # AI异步任务
│   │   └── schedule_tasks.py      # 定时任务
│   │
│   ├── websocket/                  # WebSocket
│   │   ├── __init__.py
│   │   ├── manager.py             # 连接管理
│   │   └── game_handler.py        # 游戏处理
│   │
│   ├── utils/                      # 工具函数
│   │   ├── __init__.py
│   │   ├── wechat.py              # 微信API
│   │   ├── redis_client.py
│   │   ├── oss.py
│   │   └── helpers.py
│   │
│   └── middleware/                 # 中间件
│       ├── __init__.py
│       ├── cors.py
│       ├── rate_limit.py
│       └── logging.py
│
├── alembic/                        # 数据库迁移
│   ├── versions/
│   ├── env.py
│   └── script.py.mako
│
├── tests/                          # 测试
│   ├── test_api/
│   └── test_services/
│
├── scripts/                        # 脚本
│   ├── import_poetry.py           # 导入诗词数据
│   └── init_db.py                 # 初始化数据库
│
├── requirements.txt
├── .env
├── .env.example
├── alembic.ini
├── Dockerfile
├── docker-compose.yml
└── README.md
```

---

# 第三部分：页面设计

## 3.1 用户端页面列表

### 3.1.1 底部导航（TabBar）

| Tab | 图标 | 页面路径 | 功能 |
|-----|------|---------|------|
| 首页 | 🏠 | /pages/index/index | 诗词推荐 |
| 诗词 | 📚 | /pages/poetry/list | 诗词列表 |
| 广场 | 🎪 | /pages/square/index | 用户广场 |
| 我的 | 👤 | /pages/profile/index | 个人中心 |

### 3.1.2 页面详细设计

#### 【首页】/pages/index/index.vue

**布局**：
```
┌──────────────────────────────┐
│ 【导航栏】诗词每日推荐        │
├──────────────────────────────┤
│                              │
│   ┌────────────────────┐    │
│   │  《静夜思》        │    │
│   │   唐·李白          │    │
│   │                    │    │
│   │  床前明月光，       │    │
│   │  疑是地上霜。       │    │
│   │  举头望明月，       │    │
│   │  低头思故乡。       │    │
│   │                    │    │
│   │  ❤️ 1234  💬 56   │    │
│   └────────────────────┘    │
│                              │
│   【刷新】  【详情】         │
│                              │
├──────────────────────────────┤
│ 【快捷入口】                 │
│  🤖 AI创作  🔍 搜索  🎮 飞花令│
└──────────────────────────────┘
```

**功能**：
- 每日推荐一首诗词（可刷新）
- 显示诗词内容、作者、朝代
- 点赞、评论统计
- 点击进入详情页
- 快捷入口：AI创作、搜索、飞花令

**API调用**：
- `GET /api/v1/poetry/recommend` - 获取推荐诗词

---

#### 【诗词列表】/pages/poetry/list.vue

**布局**：
```
┌──────────────────────────────┐
│ 【导航栏】诗词                │
│ 【搜索框】                    │
├──────────────────────────────┤
│ 【筛选】                      │
│  朝代 ▼  类型 ▼  诗人 ▼      │
├──────────────────────────────┤
│ ┌──────────────────────────┐ │
│ │ 《春晓》 唐·孟浩然        │ │
│ │ 春眠不觉晓...             │ │
│ │ 👁️ 1234  ❤️ 56  💬 12    │ │
│ └──────────────────────────┘ │
│ ┌──────────────────────────┐ │
│ │ 《登鹳雀楼》 唐·王之涣    │ │
│ │ 白日依山尽...             │ │
│ │ 👁️ 2345  ❤️ 78  💬 23    │ │
│ └──────────────────────────┘ │
│  ...                          │
└──────────────────────────────┘
```

**功能**：
- 搜索框（关键词搜索）
- 筛选条件（朝代、类型、诗人）
- 诗词卡片列表
- 上拉加载更多
- 点击进入详情

**API调用**：
- `GET /api/v1/poetry/list` - 获取诗词列表
- `GET /api/v1/poetry/search` - 搜索诗词

---

#### 【诗词详情】/pages/poetry/detail.vue

**布局**：
```
┌──────────────────────────────┐
│ ← 返回                        │
├──────────────────────────────┤
│  《静夜思》                   │
│   唐·李白                     │
│                              │
│  床前明月光，                 │
│  疑是地上霜。                 │
│  举头望明月，                 │
│  低头思故乡。                 │
│                              │
│  【翻译】                     │
│  明亮的月光洒在床前...        │
│                              │
│  【赏析】（AI生成）           │
│  这首诗表达了诗人...          │
│                              │
├──────────────────────────────┤
│  👁️ 12345  ❤️ 点赞  ⭐ 收藏  │
├──────────────────────────────┤
│ 【评论区】 最新 | 热评        │
│  用户A: 很喜欢这首诗...       │
│  用户B: 月夜思乡...           │
└──────────────────────────────┘
```

**功能**：
- 诗词完整内容
- 作者、朝代信息
- 翻译、赏析（可调用AI生成）
- 点赞、收藏、分享
- 评论列表（最新/热评切换）
- 发表评论

**API调用**：
- `GET /api/v1/poetry/{id}` - 获取诗词详情
- `POST /api/v1/poetry/{id}/like` - 点赞
- `POST /api/v1/poetry/{id}/collect` - 收藏
- `GET /api/v1/poetry/{id}/comments` - 获取评论
- `POST /api/v1/comments` - 发表评论
- `POST /api/v1/ai/analyze` - AI分析诗词

---

#### 【AI创作】/pages/ai/generate.vue

**布局**：
```
┌──────────────────────────────┐
│ ← AI诗词创作                  │
├──────────────────────────────┤
│  主题                         │
│  ┌────────────────────────┐  │
│  │ 请输入主题，如：明月   │  │
│  └────────────────────────┘  │
│                              │
│  风格                         │
│  [ 五言绝句 ▼ ]              │
│                              │
│  朝代风格（可选）             │
│  [ 唐代 ▼ ]                  │
│                              │
│  诗人风格（可选）             │
│  ┌────────────────────────┐  │
│  │ 如：李白                │  │
│  └────────────────────────┘  │
│                              │
│        【生成诗词】           │
│                              │
├──────────────────────────────┤
│ 【生成结果】                 │
│  明月照高楼，                 │
│  流光正徘徊。                 │
│  上有愁思妇，                 │
│  悲叹有余哀。                 │
│                              │
│  【重新生成】 【保存】        │
└──────────────────────────────┘
```

**功能**：
- 输入主题
- 选择诗词风格（五言绝句、七言律诗等）
- 选择朝代风格（可选）
- 输入诗人风格（可选）
- 生成诗词（调用AI API）
- 显示生成结果
- 重新生成、保存到收藏

**API调用**：
- `POST /api/v1/ai/generate` - AI生成诗词

---

#### 【广场】/pages/square/index.vue

**布局**：
```
┌──────────────────────────────┐
│ 【导航栏】广场                │
├──────────────────────────────┤
│  广场 | 飞花令                │
├──────────────────────────────┤
│ 【Tab: 广场】                 │
│  ┌─ 发布按钮 ─┐              │
│                              │
│ ┌──────────────────────────┐ │
│ │ 用户A  2小时前            │ │
│ │ 今天读了一首《春晓》...    │ │
│ │ [图片]                    │ │
│ │ ❤️ 12  💬 3               │ │
│ └──────────────────────────┘ │
│ ┌──────────────────────────┐ │
│ │ 用户B  5小时前            │ │
│ │ 分享我最喜欢的诗词...      │ │
│ │ ❤️ 23  💬 7               │ │
│ └──────────────────────────┘ │
└──────────────────────────────┘
```

**功能**：
- 广场内容流
- 发布内容（文字、图片）
- 点赞、评论、收藏
- 点击进入详情

**API调用**：
- `GET /api/v1/square/posts` - 获取广场内容
- `POST /api/v1/square/posts` - 发布内容

---

#### 【飞花令】/pages/game/lobby.vue

**布局**：
```
┌──────────────────────────────┐
│ ← 飞花令                      │
├──────────────────────────────┤
│  【选择模式】                 │
│                              │
│  ┌────────────────────────┐  │
│  │  🤖 AI对战              │  │
│  │  挑战AI，练习诗词       │  │
│  └────────────────────────┘  │
│                              │
│  ┌────────────────────────┐  │
│  │  🎲 随机匹配            │  │
│  │  匹配在线玩家           │  │
│  └────────────────────────┘  │
│                              │
│  ┌────────────────────────┐  │
│  │  👥 好友对战            │  │
│  │  邀请好友一起玩         │  │
│  └────────────────────────┘  │
│                              │
│  【我的战绩】                 │
│  总场次: 10  胜率: 60%       │
└──────────────────────────────┘
```

**功能**：
- 选择游戏模式：
  - AI对战（单人）
  - 随机匹配（双人）
  - 好友对战（双人）
- 显示战绩统计

**API调用**：
- `POST /api/v1/game/create` - 创建游戏
- `POST /api/v1/game/match` - 匹配玩家
- `GET /api/v1/game/stats` - 获取战绩

---

#### 【飞花令游戏】/pages/game/room.vue

**布局**：
```
┌──────────────────────────────┐
│ 关键字: 春   倒计时: 30s     │
├──────────────────────────────┤
│  对手AI                       │
│  ┌────────────────────────┐  │
│  │ 春眠不觉晓               │  │
│  └────────────────────────┘  │
│                              │
│  ─────────────────           │
│                              │
│  我                           │
│  ┌────────────────────────┐  │
│  │ 请输入包含"春"的诗句    │  │
│  └────────────────────────┘  │
│        【提交】               │
│                              │
│  【历史记录】                 │
│  1. 春眠不觉晓（对手）        │
│  2. 春风又绿江南岸（我）      │
└──────────────────────────────┘
```

**功能**：
- 显示关键字和倒计时
- 对手诗句显示
- 输入诗句并提交
- 历史记录
- 判断胜负

**API调用**：
- `POST /api/v1/game/{id}/submit` - 提交诗句
- `GET /api/v1/game/{id}/status` - 获取游戏状态
- WebSocket实时通信

---

#### 【个人中心】/pages/profile/index.vue

**布局**：
```
┌──────────────────────────────┐
│ 【用户信息卡片】              │
│  [头像]  昵称                 │
│  Lv.5 诗词爱好者              │
│  关注 12 | 粉丝 34 | 点赞 567 │
├──────────────────────────────┤
│  我的收藏  》                 │
│  我的关注  》                 │
│  我的点赞  》                 │
│  我的发布  》                 │
│  站内消息  》  [红点]         │
│  ────────────────             │
│  设置      》                 │
└──────────────────────────────┘
```

**功能**：
- 用户信息展示
- 等级、粉丝、关注统计
- 我的收藏、关注、点赞、发布
- 站内消息（红点提示）
- 设置入口

---

## 3.2 管理端页面列表

### 3.2.1 页面结构

```
管理端
├── 登录页
├── 首页（数据统计）
├── 用户管理
│   ├── 用户列表
│   └── 用户详情
├── 诗词管理
│   ├── 诗词列表
│   ├── 诗词编辑
│   ├── 批量导入
│   └── 作者管理
├── 内容管理
│   ├── 广场内容审核
│   └── 评论管理
├── 运营管理
│   ├── 推荐设置
│   └── 话题管理
└── 系统设置
    ├── AI配置
    └── 系统参数
```

### 3.2.2 关键页面设计

#### 【AI配置】/admin/system/ai-config

**布局**：
```
AI服务配置
┌─────────────────────────────────┐
│ 基础配置                         │
│                                 │
│ 是否启用AI功能                   │
│ [ ☑ 启用 ]                      │
│                                 │
│ AI服务商URL                      │
│ ┌───────────────────────────┐   │
│ │https://dashscope.aliyun...│   │
│ └───────────────────────────┘   │
│                                 │
│ API Key                         │
│ ┌───────────────────────────┐   │
│ │sk-xxxxxxxxxxxxxxxxx       │   │
│ └───────────────────────────┘   │
│                                 │
│ 模型名称                         │
│ ┌───────────────────────────┐   │
│ │qwen-turbo                 │   │
│ └───────────────────────────┘   │
│                                 │
│       【测试连接】 【保存】       │
└─────────────────────────────────┘
```

**功能**：
- 配置AI服务商URL
- 配置API Key
- 配置模型名称
- 测试连接
- 保存配置

---

# 第四部分：数据库设计

## 4.1 数据库表设计

### 4.1.1 用户表（users）

```sql
CREATE TABLE `users` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `openid` VARCHAR(100) DEFAULT NULL COMMENT '微信openid',
  `unionid` VARCHAR(100) DEFAULT NULL COMMENT '微信unionid',
  `username` VARCHAR(50) DEFAULT NULL COMMENT '登录账号',
  `password` VARCHAR(255) DEFAULT NULL COMMENT '密码（加密）',
  `nickname` VARCHAR(50) NOT NULL COMMENT '昵称',
  `avatar` VARCHAR(500) DEFAULT NULL COMMENT '头像URL',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `gender` TINYINT DEFAULT 0 COMMENT '性别：0未知 1男 2女',
  `intro` VARCHAR(200) DEFAULT NULL COMMENT '个人简介',
  `level` INT DEFAULT 1 COMMENT '用户等级',
  `exp` INT DEFAULT 0 COMMENT '经验值',
  `status` TINYINT DEFAULT 1 COMMENT '状态：1正常 2封禁',
  `register_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
  `last_login_time` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_nickname` (`nickname`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 4.1.2 诗词表（poetry）

```sql
CREATE TABLE `poetry` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '诗词ID',
  `title` VARCHAR(100) NOT NULL COMMENT '标题',
  `content` TEXT NOT NULL COMMENT '内容',
  `author` VARCHAR(50) NOT NULL COMMENT '作者',
  `dynasty` VARCHAR(20) NOT NULL COMMENT '朝代',
  `type` VARCHAR(20) DEFAULT NULL COMMENT '类型：五言绝句、七言律诗等',
  `translation` TEXT DEFAULT NULL COMMENT '翻译',
  `annotation` TEXT DEFAULT NULL COMMENT '注释',
  `appreciation` TEXT DEFAULT NULL COMMENT '赏析',
  `tags` JSON DEFAULT NULL COMMENT '标签',
  `read_count` INT DEFAULT 0 COMMENT '阅读数',
  `like_count` INT DEFAULT 0 COMMENT '点赞数',
  `comment_count` INT DEFAULT 0 COMMENT '评论数',
  `collect_count` INT DEFAULT 0 COMMENT '收藏数',
  `status` TINYINT DEFAULT 1 COMMENT '状态：1已发布 2草稿 3已删除',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_author` (`author`),
  KEY `idx_dynasty` (`dynasty`),
  KEY `idx_type` (`type`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='诗词表';
```

### 4.1.3 评论表（comments）

```sql
CREATE TABLE `comments` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '评论ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `target_type` VARCHAR(20) NOT NULL COMMENT '目标类型：poetry/post',
  `target_id` BIGINT UNSIGNED NOT NULL COMMENT '目标ID',
  `parent_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '父评论ID（二级评论）',
  `content` TEXT NOT NULL COMMENT '评论内容',
  `like_count` INT DEFAULT 0 COMMENT '点赞数',
  `reply_count` INT DEFAULT 0 COMMENT '回复数',
  `status` TINYINT DEFAULT 1 COMMENT '状态：1正常 2已删除',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_target` (`target_type`, `target_id`),
  KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评论表';
```

### 4.1.4 点赞表（likes）

```sql
CREATE TABLE `likes` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `target_type` VARCHAR(20) NOT NULL COMMENT '目标类型：poetry/post/comment',
  `target_id` BIGINT UNSIGNED NOT NULL COMMENT '目标ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_target` (`user_id`, `target_type`, `target_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='点赞表';
```

### 4.1.5 收藏表（collects）

```sql
CREATE TABLE `collects` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `target_type` VARCHAR(20) NOT NULL COMMENT '目标类型：poetry/post',
  `target_id` BIGINT UNSIGNED NOT NULL COMMENT '目标ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_target` (`user_id`, `target_type`, `target_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='收藏表';
```

### 4.1.6 广场内容表（posts）

```sql
CREATE TABLE `posts` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `content` TEXT NOT NULL COMMENT '内容',
  `images` JSON DEFAULT NULL COMMENT '图片URLs',
  `tags` JSON DEFAULT NULL COMMENT '标签',
  `like_count` INT DEFAULT 0 COMMENT '点赞数',
  `comment_count` INT DEFAULT 0 COMMENT '评论数',
  `collect_count` INT DEFAULT 0 COMMENT '收藏数',
  `view_count` INT DEFAULT 0 COMMENT '浏览数',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0待审核 1已发布 2已删除',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='广场内容表';
```

### 4.1.7 游戏房间表（game_rooms）

```sql
CREATE TABLE `game_rooms` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `room_type` VARCHAR(20) NOT NULL COMMENT '房间类型：ai/random/friend',
  `keyword` VARCHAR(10) NOT NULL COMMENT '关键字',
  `player1_id` BIGINT UNSIGNED NOT NULL COMMENT '玩家1 ID',
  `player2_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '玩家2 ID（AI为NULL）',
  `current_player` TINYINT DEFAULT 1 COMMENT '当前回合玩家：1或2',
  `round` INT DEFAULT 0 COMMENT '当前回合数',
  `max_round` INT DEFAULT 10 COMMENT '最大回合数',
  `time_limit` INT DEFAULT 30 COMMENT '回答时间限制（秒）',
  `status` TINYINT DEFAULT 0 COMMENT '状态：0等待 1进行中 2已结束',
  `winner_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '获胜者ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `started_at` DATETIME DEFAULT NULL COMMENT '开始时间',
  `ended_at` DATETIME DEFAULT NULL COMMENT '结束时间',
  PRIMARY KEY (`id`),
  KEY `idx_player1` (`player1_id`),
  KEY `idx_player2` (`player2_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='游戏房间表';
```

### 4.1.8 游戏记录表（game_records）

```sql
CREATE TABLE `game_records` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `room_id` BIGINT UNSIGNED NOT NULL COMMENT '房间ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `poetry_content` VARCHAR(200) NOT NULL COMMENT '诗句内容',
  `round` INT NOT NULL COMMENT '回合数',
  `is_correct` TINYINT DEFAULT 1 COMMENT '是否正确',
  `answer_time` INT DEFAULT 0 COMMENT '作答时间（秒）',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_room_id` (`room_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='游戏记录表';
```

### 4.1.9 消息表（messages）

```sql
CREATE TABLE `messages` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '接收用户ID',
  `type` VARCHAR(20) NOT NULL COMMENT '消息类型：system/like/comment/follow',
  `title` VARCHAR(100) DEFAULT NULL COMMENT '标题',
  `content` TEXT DEFAULT NULL COMMENT '内容',
  `related_type` VARCHAR(20) DEFAULT NULL COMMENT '关联类型',
  `related_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '关联ID',
  `from_user_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '发送者ID',
  `is_read` TINYINT DEFAULT 0 COMMENT '是否已读：0未读 1已读',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_is_read` (`is_read`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息表';
```

### 4.1.10 阅读记录表（poetry_reads）

```sql
CREATE TABLE `poetry_reads` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `poetry_id` BIGINT UNSIGNED NOT NULL COMMENT '诗词ID',
  `read_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '阅读时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_poetry` (`user_id`, `poetry_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='阅读记录表';
```

---

# 第五部分：API接口文档

## 5.1 接口规范

### 5.1.1 基础信息

- **Base URL**: `https://api.yourdomain.com/api/v1`
- **协议**: HTTPS
- **请求格式**: JSON
- **响应格式**: JSON
- **字符编码**: UTF-8

### 5.1.2 通用响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

**状态码说明**：
- `200`: 成功
- `400`: 请求参数错误
- `401`: 未授权（未登录）
- `403`: 无权限
- `404`: 资源不存在
- `500`: 服务器内部错误

### 5.1.3 认证方式

**JWT Token认证**：

请求头：
```
Authorization: Bearer <token>
```

## 5.2 认证相关接口

### 5.2.1 微信小程序登录

**接口**：`POST /auth/wechat/login`

**请求参数**：
```json
{
  "code": "微信登录code"
}
```

**响应**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "user": {
      "id": 1,
      "nickname": "用户昵称",
      "avatar": "https://...",
      "level": 5
    }
  }
}
```

### 5.2.2 账号密码登录（H5）

**接口**：`POST /auth/login`

**请求参数**：
```json
{
  "username": "user123",
  "password": "password123"
}
```

**响应**：同上

### 5.2.3 注册（H5）

**接口**：`POST /auth/register`

**请求参数**：
```json
{
  "username": "user123",
  "password": "password123",
  "nickname": "昵称"
}
```

## 5.3 诗词相关接口

### 5.3.1 获取推荐诗词

**接口**：`GET /poetry/recommend`

**请求参数**：无

**响应**：
```json
{
  "code": 200,
  "data": {
    "id": 123,
    "title": "静夜思",
    "content": "床前明月光，疑是地上霜。举头望明月，低头思故乡。",
    "author": "李白",
    "dynasty": "唐代",
    "read_count": 12345,
    "like_count": 567,
    "comment_count": 89,
    "is_liked": false,
    "is_collected": false
  }
}
```

### 5.3.2 获取诗词列表

**接口**：`GET /poetry/list`

**请求参数**：
```
page=1
page_size=20
dynasty=唐代（可选）
type=五言绝句（可选）
author=李白（可选）
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "total": 100,
    "page": 1,
    "page_size": 20,
    "items": [
      {
        "id": 123,
        "title": "春晓",
        "content": "春眠不觉晓...",
        "author": "孟浩然",
        "dynasty": "唐代",
        "read_count": 1234,
        "like_count": 56,
        "comment_count": 12
      }
    ]
  }
}
```

### 5.3.3 搜索诗词

**接口**：`GET /poetry/search`

**请求参数**：
```
keyword=明月
page=1
page_size=20
```

**响应**：同诗词列表

### 5.3.4 获取诗词详情

**接口**：`GET /poetry/{id}`

**响应**：
```json
{
  "code": 200,
  "data": {
    "id": 123,
    "title": "静夜思",
    "content": "床前明月光，疑是地上霜。举头望明月，低头思故乡。",
    "author": "李白",
    "dynasty": "唐代",
    "type": "五言绝句",
    "translation": "明亮的月光洒在床前的窗户纸上...",
    "annotation": "床：井栏。...",
    "appreciation": "这首诗写的是在寂静的月夜思念家乡的感受...",
    "tags": ["思乡", "月夜"],
    "read_count": 12345,
    "like_count": 567,
    "comment_count": 89,
    "collect_count": 234,
    "is_liked": false,
    "is_collected": false
  }
}
```

### 5.3.5 点赞诗词

**接口**：`POST /poetry/{id}/like`

**请求头**：需要Authorization

**响应**：
```json
{
  "code": 200,
  "message": "点赞成功",
  "data": {
    "like_count": 568
  }
}
```

### 5.3.6 取消点赞

**接口**：`DELETE /poetry/{id}/like`

### 5.3.7 收藏诗词

**接口**：`POST /poetry/{id}/collect`

### 5.3.8 取消收藏

**接口**：`DELETE /poetry/{id}/collect`

## 5.4 评论相关接口

### 5.4.1 获取评论列表

**接口**：`GET /poetry/{id}/comments`

**请求参数**：
```
sort=latest  # latest/hot
page=1
page_size=20
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "total": 89,
    "items": [
      {
        "id": 1001,
        "user": {
          "id": 1,
          "nickname": "用户A",
          "avatar": "https://..."
        },
        "content": "很喜欢这首诗",
        "like_count": 12,
        "reply_count": 3,
        "is_liked": false,
        "created_at": "2024-11-06 10:30:00",
        "replies": [
          {
            "id": 1002,
            "user": {...},
            "content": "同感",
            "created_at": "2024-11-06 11:00:00"
          }
        ]
      }
    ]
  }
}
```

### 5.4.2 发表评论

**接口**：`POST /comments`

**请求参数**：
```json
{
  "target_type": "poetry",
  "target_id": 123,
  "parent_id": null,
  "content": "很喜欢这首诗"
}
```

**响应**：
```json
{
  "code": 200,
  "message": "评论成功",
  "data": {
    "id": 1001,
    "content": "很喜欢这首诗",
    "created_at": "2024-11-06 10:30:00"
  }
}
```

### 5.4.3 删除评论

**接口**：`DELETE /comments/{id}`

## 5.5 AI功能接口 🤖

### 5.5.1 AI生成诗词

**接口**：`POST /ai/generate`

**请求参数**：
```json
{
  "prompt": "明月",
  "style": "五言绝句",
  "dynasty": "唐代",
  "author_style": "李白"
}
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "poetry": "明月照高楼，\n流光正徘徊。\n上有愁思妇，\n悲叹有余哀。",
    "title": "月夜",
    "explanation": "AI创作，模仿唐代李白风格"
  }
}
```

### 5.5.2 AI分析诗词

**接口**：`POST /ai/analyze`

**请求参数**：
```json
{
  "poetry_id": 123
}
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "translation": "明亮的月光洒在床前...",
    "appreciation": "这首诗写的是在寂静的月夜思念家乡的感受...",
    "emotion": "思乡",
    "keywords": ["明月", "思乡", "夜晚"]
  }
}
```

### 5.5.3 飞花令AI对手

**接口**：`POST /ai/feihualing`

**请求参数**：
```json
{
  "keyword": "春",
  "history": ["春眠不觉晓", "春风又绿江南岸"]
}
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "poetry_line": "春江潮水连海平"
  }
}
```

## 5.6 广场相关接口

### 5.6.1 获取广场内容

**接口**：`GET /square/posts`

**请求参数**：
```
page=1
page_size=20
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "total": 100,
    "items": [
      {
        "id": 1,
        "user": {
          "id": 1,
          "nickname": "用户A",
          "avatar": "https://..."
        },
        "content": "今天读了一首《春晓》...",
        "images": ["https://...", "https://..."],
        "like_count": 12,
        "comment_count": 3,
        "is_liked": false,
        "created_at": "2024-11-06 10:00:00"
      }
    ]
  }
}
```

### 5.6.2 发布内容

**接口**：`POST /square/posts`

**请求参数**：
```json
{
  "content": "分享我最喜欢的诗词",
  "images": ["https://...", "https://..."],
  "tags": ["诗词", "分享"]
}
```

### 5.6.3 删除内容

**接口**：`DELETE /square/posts/{id}`

## 5.7 飞花令游戏接口

### 5.7.1 创建游戏

**接口**：`POST /game/create`

**请求参数**：
```json
{
  "room_type": "ai",  // ai/random/friend
  "keyword": "春"
}
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "room_id": 1001,
    "keyword": "春",
    "player1_id": 1,
    "player2_id": null,
    "status": "进行中"
  }
}
```

### 5.7.2 提交诗句

**接口**：`POST /game/{room_id}/submit`

**请求参数**：
```json
{
  "poetry_line": "春眠不觉晓"
}
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "is_correct": true,
    "message": "正确",
    "opponent_line": "春风又绿江南岸",
    "round": 2,
    "game_status": "进行中"
  }
}
```

### 5.7.3 获取游戏状态

**接口**：`GET /game/{room_id}/status`

### 5.7.4 获取战绩

**接口**：`GET /game/stats`

**响应**：
```json
{
  "code": 200,
  "data": {
    "total_games": 10,
    "wins": 6,
    "losses": 4,
    "win_rate": 0.6
  }
}
```

## 5.8 个人中心接口

### 5.8.1 获取个人信息

**接口**：`GET /users/me`

**响应**：
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "nickname": "用户昵称",
    "avatar": "https://...",
    "level": 5,
    "exp": 1234,
    "follow_count": 12,
    "fans_count": 34,
    "like_count": 567
  }
}
```

### 5.8.2 获取我的收藏

**接口**：`GET /users/me/collects`

**请求参数**：
```
page=1
page_size=20
```

### 5.8.3 获取我的关注

**接口**：`GET /users/me/follows`

### 5.8.4 获取我的粉丝

**接口**：`GET /users/me/fans`

### 5.8.5 获取站内消息

**接口**：`GET /messages`

**请求参数**：
```
type=all  # all/system/like/comment/follow
page=1
page_size=20
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "unread_count": 5,
    "items": [
      {
        "id": 1,
        "type": "like",
        "title": "用户A点赞了你的评论",
        "content": "很喜欢这首诗",
        "is_read": false,
        "created_at": "2024-11-06 10:00:00"
      }
    ]
  }
}
```

### 5.8.6 标记消息已读

**接口**：`PUT /messages/{id}/read`

## 5.9 管理端接口

### 5.9.1 获取数据统计

**接口**：`GET /admin/stats`

**响应**：
```json
{
  "code": 200,
  "data": {
    "user_count": 10000,
    "poetry_count": 50000,
    "today_active_users": 500,
    "today_new_users": 20
  }
}
```

### 5.9.2 获取用户列表

**接口**：`GET /admin/users`

**请求参数**：
```
page=1
page_size=20
keyword=昵称（可选）
status=1（可选）
```

### 5.9.3 诗词批量导入

**接口**：`POST /admin/poetry/import`

**请求参数**：multipart/form-data
```
file: 诗词JSON文件
```

### 5.9.4 AI配置保存

**接口**：`PUT /admin/system/ai-config`

**请求参数**：
```json
{
  "enabled": true,
  "provider_url": "https://dashscope.aliyuncs.com/...",
  "api_key": "sk-xxxxxxxxx",
  "model": "qwen-turbo"
}
```

---

# 第六部分：AI服务实现

## 6.1 AI服务配置

### 6.1.1 配置文件（.env）

```env
# AI服务配置
AI_ENABLED=true
AI_PROVIDER_URL=https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
AI_API_KEY=sk-xxxxxxxxxxxxxxxxxx
AI_MODEL=qwen-turbo
AI_TIMEOUT=30
```

### 6.1.2 配置类（config.py）

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # AI服务配置
    AI_ENABLED: bool = True
    AI_PROVIDER_URL: str
    AI_API_KEY: str
    AI_MODEL: str = "qwen-turbo"
    AI_TIMEOUT: int = 30

    class Config:
        env_file = ".env"

settings = Settings()
```

## 6.2 AI服务实现代码

### 6.2.1 AI服务基类（services/ai_service/base.py）

```python
import httpx
from app.core.config import settings

class AIServiceBase:
    """AI服务基类"""

    def __init__(self):
        self.provider_url = settings.AI_PROVIDER_URL
        self.api_key = settings.AI_API_KEY
        self.model = settings.AI_MODEL
        self.timeout = settings.AI_TIMEOUT

    async def call_api(self, prompt: str, **kwargs) -> str:
        """
        调用AI API

        Args:
            prompt: 提示词
            **kwargs: 其他参数（temperature, max_tokens等）

        Returns:
            AI生成的文本
        """
        async with httpx.AsyncClient() as client:
            response = await client.post(
                self.provider_url,
                headers={
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                },
                json={
                    "model": self.model,
                    "input": {
                        "messages": [
                            {"role": "user", "content": prompt}
                        ]
                    },
                    "parameters": {
                        "temperature": kwargs.get("temperature", 0.8),
                        "max_tokens": kwargs.get("max_tokens", 500)
                    }
                },
                timeout=self.timeout
            )

            if response.status_code == 200:
                result = response.json()
                # 根据不同AI厂商的响应格式提取文本
                # 通义千问格式
                return result['output']['text']
            else:
                raise Exception(f"AI API调用失败: {response.text}")
```

### 6.2.2 诗词生成服务（services/ai_service/generator.py）

```python
from .base import AIServiceBase

class PoetryGenerator(AIServiceBase):
    """诗词生成服务"""

    async def generate(
        self,
        prompt: str,
        style: str = "五言绝句",
        dynasty: str = "唐代",
        author_style: str = None
    ) -> dict:
        """
        生成诗词

        Args:
            prompt: 主题
            style: 诗词体裁
            dynasty: 朝代风格
            author_style: 诗人风格

        Returns:
            {
                "poetry": "生成的诗词",
                "title": "标题",
                "explanation": "说明"
            }
        """
        # 构造提示词
        system_prompt = f"""你是一位精通中国古典诗词的AI诗人。
请根据用户提供的主题和要求，创作一首优美的{style}。
要求：
1. 符合{style}的格律
2. 意境优美，富有诗意
3. 用词典雅，符合古典诗词风格
"""

        user_prompt = f"主题：{prompt}\n体裁：{style}\n朝代风格：{dynasty}"

        if author_style:
            user_prompt += f"\n请模仿{author_style}的风格"

        user_prompt += f"\n\n请创作一首{style}，主题围绕"{prompt}"。只返回诗词内容，不要其他说明。"

        # 调用AI API
        poetry_text = await self.call_api(
            f"{system_prompt}\n\n{user_prompt}",
            temperature=0.8
        )

        return {
            "poetry": poetry_text.strip(),
            "title": self._extract_title(poetry_text),
            "explanation": f"AI创作，{dynasty}风格{style}"
        }

    def _extract_title(self, text: str) -> str:
        """提取标题"""
        lines = text.strip().split('\n')
        return lines[0] if lines else "无题"
```

### 6.2.3 诗词分析服务（services/ai_service/analyzer.py）

```python
from .base import AIServiceBase
import json

class PoetryAnalyzer(AIServiceBase):
    """诗词分析服务"""

    async def analyze(self, poetry_content: str) -> dict:
        """
        分析诗词

        Returns:
            {
                "translation": "翻译",
                "appreciation": "赏析",
                "emotion": "情感",
                "keywords": ["关键词"]
            }
        """
        prompt = f"""请分析以下诗词：

{poetry_content}

请提供：
1. 现代文翻译
2. 简要赏析（100字以内）
3. 情感分析（如：思乡、豪迈、婉约等）
4. 关键词（3-5个）

请以JSON格式返回：
{{
    "translation": "...",
    "appreciation": "...",
    "emotion": "...",
    "keywords": ["...", "..."]
}}
"""

        result_text = await self.call_api(prompt)

        # 解析JSON
        try:
            result = json.loads(result_text)
            return result
        except:
            # 如果解析失败，返回默认值
            return {
                "translation": "翻译生成失败",
                "appreciation": result_text,
                "emotion": "未知",
                "keywords": []
            }
```

### 6.2.4 飞花令AI（services/ai_service/game.py）

```python
from .base import AIServiceBase

class FeiHuaLingAI(AIServiceBase):
    """飞花令AI对手"""

    async def generate_response(
        self,
        keyword: str,
        history: list[str]
    ) -> str:
        """
        生成飞花令诗句

        Args:
            keyword: 关键字
            history: 已使用的诗句列表

        Returns:
            包含关键字的诗句
        """
        prompt = f"""这是一场飞花令游戏，关键字是"{keyword}"。

已使用的诗句：
{chr(10).join(history) if history else '（暂无）'}

请说出一句包含"{keyword}"字的古诗词，要求：
1. 不能重复已使用的诗句
2. 必须是真实的古诗词（唐诗宋词）
3. 只返回诗句本身，不要其他说明
"""

        poetry_line = await self.call_api(prompt, temperature=0.7)

        # 验证是否包含关键字
        if keyword not in poetry_line:
            raise ValueError("AI返回的诗句不包含关键字")

        return poetry_line.strip()
```

## 6.3 API路由实现（api/v1/ai.py）

```python
from fastapi import APIRouter, HTTPException, Depends
from app.schemas.ai import (
    PoetryGenerateRequest,
    PoetryGenerateResponse,
    PoetryAnalyzeRequest,
    PoetryAnalyzeResponse,
    FeiHuaLingRequest,
    FeiHuaLingResponse
)
from app.services.ai_service.generator import PoetryGenerator
from app.services.ai_service.analyzer import PoetryAnalyzer
from app.services.ai_service.game import FeiHuaLingAI

router = APIRouter(prefix="/ai", tags=["AI功能"])

@router.post("/generate", response_model=PoetryGenerateResponse)
async def generate_poetry(request: PoetryGenerateRequest):
    """AI生成诗词"""
    try:
        generator = PoetryGenerator()
        result = await generator.generate(
            prompt=request.prompt,
            style=request.style,
            dynasty=request.dynasty,
            author_style=request.author_style
        )
        return {"code": 200, "data": result}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/analyze", response_model=PoetryAnalyzeResponse)
async def analyze_poetry(request: PoetryAnalyzeRequest):
    """AI分析诗词"""
    try:
        analyzer = PoetryAnalyzer()
        result = await analyzer.analyze(request.poetry_content)
        return {"code": 200, "data": result}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/feihualing", response_model=FeiHuaLingResponse)
async def feihualing_ai(request: FeiHuaLingRequest):
    """飞花令AI对手"""
    try:
        ai = FeiHuaLingAI()
        poetry_line = await ai.generate_response(
            keyword=request.keyword,
            history=request.history
        )
        return {"code": 200, "data": {"poetry_line": poetry_line}}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

---

# 第七部分：开发规范

## 7.1 代码规范

### 7.1.1 Python代码规范（PEP 8）

```python
# 文件命名：小写+下划线
# poetry_service.py

# 类名：PascalCase
class PoetryService:
    pass

# 函数名：小写+下划线
async def get_poetry_by_id(poetry_id: int):
    pass

# 常量：大写+下划线
MAX_PAGE_SIZE = 100

# 变量名：小写+下划线
poetry_list = []
```

### 7.1.2 Vue代码规范

```vue
<!-- 组件名：PascalCase -->
<!-- PoetryCard.vue -->

<script setup lang="ts">
// 变量名：camelCase
const poetryList = ref([])

// 函数名：camelCase
const fetchPoetryList = async () => {}
</script>
```

## 7.2 Git提交规范

```bash
# 格式：<type>(<scope>): <subject>

feat(poetry): 添加诗词列表筛选功能
fix(user): 修复登录token过期问题
docs(readme): 更新部署文档
style(ui): 调整诗词卡片样式
refactor(api): 重构AI服务调用逻辑
test(poetry): 添加诗词服务单元测试
chore(deps): 升级依赖包版本
```

## 7.3 分支管理

```
main（master）       # 生产环境
  ├── develop         # 开发环境
  │   ├── feature/xxx # 功能分支
  │   ├── bugfix/xxx  # bug修复分支
  │   └── hotfix/xxx  # 紧急修复分支
```

---

# 第八部分：部署指南

## 8.1 环境要求

### 8.1.1 服务器配置

**推荐配置**：
- CPU: 2核
- 内存: 4GB
- 硬盘: 50GB SSD
- 带宽: 5Mbps
- 系统: Ubuntu 20.04 LTS / CentOS 7+

### 8.1.2 软件环境

- Python 3.11+
- MySQL 8.0+
- Redis 6.0+
- Nginx 1.18+
- Docker 20.10+ (可选)

## 8.2 部署步骤

### 8.2.1 后端部署

```bash
# 1. 克隆代码
git clone <repository-url>
cd server

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑.env，填入配置

# 5. 初始化数据库
alembic upgrade head

# 6. 导入诗词数据
python scripts/import_poetry.py

# 7. 启动服务
uvicorn app.main:app --host 0.0.0.0 --port 8000

# 或使用Gunicorn（生产环境）
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 8.2.2 前端部署

```bash
# uni-app（小程序+H5）
cd client-app
npm install
npm run build:mp-weixin  # 编译小程序
npm run build:h5         # 编译H5

# 管理端
cd admin-web
npm install
npm run build
```

### 8.2.3 Nginx配置

```nginx
# /etc/nginx/sites-available/poetry

# 后端API
upstream api_backend {
    server 127.0.0.1:8000;
}

# H5网站
server {
    listen 80;
    server_name h5.yourdomain.com;

    location / {
        root /var/www/poetry/client-h5/dist;
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 管理端
server {
    listen 80;
    server_name admin.yourdomain.com;

    location / {
        root /var/www/poetry/admin-web/dist;
        try_files $uri $uri/ /index.html;
    }
}

# API服务
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 8.3 Docker部署（推荐）

### 8.3.1 docker-compose.yml

```yaml
version: '3.8'

services:
  # 后端服务
  api:
    build: ./server
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=mysql+aiomysql://root:password@mysql:3306/poetry_db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - mysql
      - redis
    volumes:
      - ./server:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000

  # MySQL
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: poetry_db
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # Nginx
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./client-app/dist/h5:/usr/share/nginx/html/h5
      - ./admin-web/dist:/usr/share/nginx/html/admin
    depends_on:
      - api

volumes:
  mysql_data:
  redis_data:
```

### 8.3.2 启动部署

```bash
docker-compose up -d
```

---

# 第九部分：测试计划

## 9.1 测试类型

### 9.1.1 单元测试

测试后端API接口和服务层逻辑

### 9.1.2 集成测试

测试前后端集成、数据库交互

### 9.1.3 端到端测试

测试完整用户流程

## 9.2 测试用例（示例）

### 9.2.1 用户登录测试

| 测试项 | 测试步骤 | 预期结果 |
|--------|---------|---------|
| 微信登录成功 | 1. 点击微信登录<br>2. 授权获取用户信息 | 登录成功，返回token |
| 账号密码登录 | 1. 输入账号密码<br>2. 点击登录 | 登录成功 |
| 错误密码 | 输入错误密码 | 提示密码错误 |

### 9.2.2 AI生成诗词测试

| 测试项 | 测试步骤 | 预期结果 |
|--------|---------|---------|
| 生成五言绝句 | 输入主题"明月"，选择五言绝句 | 生成符合格式的诗词 |
| AI配置错误 | AI Key配置错误 | 提示配置错误 |
| 网络超时 | 模拟网络超时 | 提示超时，请重试 |

---

# 第十部分：项目里程碑

## 10.1 开发阶段

### 阶段一：基础功能（4-6周）

**Week 1-2**：
- [ ] 项目初始化
- [ ] 数据库设计和建表
- [ ] 用户认证模块（登录、注册）
- [ ] 诗词列表、详情API

**Week 3-4**：
- [ ] 诗词搜索、筛选
- [ ] 评论功能
- [ ] 点赞、收藏功能
- [ ] 前端页面开发（首页、列表、详情）

**Week 5-6**：
- [ ] 基础推荐算法（协同过滤）
- [ ] 个人中心功能
- [ ] 站内消息
- [ ] 单元测试

### 阶段二：AI功能（1-2周）

**Week 7-8**：
- [ ] AI服务配置
- [ ] AI诗词生成功能
- [ ] AI诗词分析功能
- [ ] 飞花令AI对手
- [ ] AI功能前端页面

### 阶段三：社交功能（2-3周）

**Week 9-11**：
- [ ] 广场功能（发布、浏览）
- [ ] 关注系统
- [ ] 互动功能（点赞、评论）
- [ ] 前端页面开发

### 阶段四：游戏功能（2-3周）

**Week 12-14**：
- [ ] 飞花令游戏逻辑
- [ ] WebSocket实时通信
- [ ] 匹配系统
- [ ] 游戏记录、排行榜

### 阶段五：管理端（2-3周）

**Week 15-17**：
- [ ] 管理后台开发
- [ ] 用户管理
- [ ] 诗词管理
- [ ] 内容审核
- [ ] 数据统计

### 阶段六：测试与优化（1-2周）

**Week 18-19**：
- [ ] 功能测试
- [ ] 性能优化
- [ ] Bug修复
- [ ] 部署上线

---

# 附录

## A. 常见问题

### A.1 AI服务相关

**Q: 如何申请AI API Key？**

A:
1. 访问阿里云：https://dashscope.aliyun.com/
2. 注册/登录账号
3. 开通通义千问服务
4. 创建API Key
5. 新用户有免费额度

**Q: AI调用失败怎么办？**

A:
1. 检查API Key是否正确
2. 检查网络连接
3. 查看错误日志
4. 确认余额是否充足

**Q: 如何切换AI服务商？**

A: 修改.env文件中的配置：
```env
AI_PROVIDER_URL=<新的URL>
AI_API_KEY=<新的Key>
AI_MODEL=<新的模型>
```

### A.2 部署相关

**Q: 如何导入诗词数据？**

A: 运行导入脚本：
```bash
python scripts/import_poetry.py
```

**Q: 数据库迁移失败？**

A: 检查数据库连接配置，查看alembic日志

## B. 参考资料

- FastAPI官方文档：https://fastapi.tiangolo.com/
- uni-app官方文档：https://uniapp.dcloud.net.cn/
- Element Plus文档：https://element-plus.org/
- 通义千问API文档：https://help.aliyun.com/zh/dashscope/

---

**文档结束**

本文档为最终开发需求文档，包含完整的技术选型、项目结构、页面设计、接口文档和AI集成方案。

开发团队应严格按照本文档进行开发。如有疑问或需要调整，请及时沟通确认。

**版本历史**：
- v1.0 (2024-11-06): 初始版本
